<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plataforma Regenera ‚Ä¢ Cooperativa</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Poppins:wght@600;700&display=swap" rel="stylesheet">

  <!-- Charts (PowerBI-like) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --green:#1B7F5A;
      --green2:#4CAF8F;
      --blue:#0D3B66;
      --yellow:#F2C94C;
      --bg:#F5F7F6;
      --card:#ffffff;
      --graphite:#182018;
      --muted:#5B6B62;
      --line: rgba(13,59,102,.12);
      --shadow: 0 18px 50px rgba(13,59,102,.10);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--graphite);
      background:
        radial-gradient(900px 700px at 90% 0%, rgba(13,59,102,.06), transparent 55%),
        linear-gradient(180deg, #eef4f1 0%, #f6faf8 60%, #ffffff 100%);
      overflow-x:hidden;
    }
    html{ visibility:hidden; }

    /* TOPBAR */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,.86);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(13,59,102,.08);
    }
    .topbar-inner{
      max-width: 1220px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 240px;
    }
    .logo{
      width: 40px; height: 40px;
      border-radius: 14px;
      display:grid; place-items:center;
      background: rgba(27,127,90,.10);
      border: 1px solid rgba(27,127,90,.18);
      box-shadow: 0 12px 24px rgba(13,59,102,.10);
      font-size: 18px;
    }
    .brand strong{
      font-family: Poppins, Inter, sans-serif;
      letter-spacing: -.02em;
      font-size: 14px;
      display:block;
      line-height: 1.1;
    }
    .brand span{
      display:block;
      font-size: 12px;
      font-weight: 900;
      opacity: .75;
      margin-top: 2px;
    }

    .actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .pill{
      border: 1px solid rgba(13,59,102,.14);
      background: rgba(245,247,246,.92);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 900;
      cursor:pointer;
      display:flex; align-items:center; gap:10px;
      color: rgba(13,59,102,.92);
    }
    .badge{
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 1000;
      background: rgba(27,127,90,.10);
      border: 1px solid rgba(27,127,90,.18);
      color: rgba(12,77,68,.95);
      font-size: 12px;
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }
    .badge.neutral{
      background: rgba(13,59,102,.08);
      border: 1px solid rgba(13,59,102,.14);
      color: rgba(13,59,102,.92);
    }

    /* LAYOUT */
    .layout{
      max-width: 1220px;
      margin: 0 auto;
      padding: 16px 18px 38px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
    }
    .sidebar{
      position: sticky;
      top: 78px;
      align-self: start;
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(13,59,102,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      backdrop-filter: blur(10px);
    }
    @media (max-width: 980px){
      .sidebar{ position: relative; top: 0; }
    }

    .nav-title{
      font-family: Poppins, Inter, sans-serif;
      font-weight: 800;
      letter-spacing: -.02em;
      font-size: 14px;
      margin: 4px 0 10px;
      color: rgba(27,127,90,.95);
    }
    .nav{
      display:flex;
      flex-direction: column;
      gap: 8px;
    }
    .nav button{
      width: 100%;
      text-align:left;
      border: 1px solid rgba(13,59,102,.12);
      background: rgba(245,247,246,.70);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 1000;
      cursor:pointer;
      color: rgba(13,59,102,.92);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      transition: transform .12s ease, filter .18s ease, background .18s ease;
    }
    .nav button:hover{ filter: brightness(1.01); transform: translateY(-1px); }
    .nav button.active{
      background: rgba(76,175,143,.14);
      border-color: rgba(76,175,143,.26);
      color: #0c4d44;
    }
    .nav small{ font-weight: 1000; opacity: .75; }

    .content{ min-height: 60vh; }
    .section{ display:none; }
    .section.active{ display:block; }

    .card{
      background: var(--card);
      border: 1px solid rgba(13,59,102,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 14px;
    }
    .card h2{
      margin: 2px 0 8px;
      font-family: Poppins, Inter, sans-serif;
      font-size: 16px;
      letter-spacing: -.02em;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .sub{
      color: rgba(24,32,24,.68);
      font-weight: 800;
      font-size: 12.5px;
      line-height: 1.5;
      margin: 0 0 12px;
      max-width: 110ch;
    }

    .kpi{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 760px){
      .kpi{ grid-template-columns: 1fr; }
    }
    .kpi .box{
      border: 1px solid rgba(13,59,102,.10);
      background: rgba(245,247,246,.70);
      border-radius: 16px;
      padding: 12px;
    }
    .kpi .box b{
      display:block;
      font-size: 18px;
      font-weight: 1000;
      letter-spacing: -.02em;
    }
    .kpi .box span{
      display:block;
      margin-top: 4px;
      font-size: 12px;
      font-weight: 900;
      opacity: .7;
    }

    .table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 16px;
      border: 1px solid rgba(13,59,102,.10);
    }
    .table th, .table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(13,59,102,.08);
      font-size: 12.5px;
      text-align:left;
      vertical-align: top;
    }
    .table th{
      background: rgba(13,59,102,.05);
      color: rgba(13,59,102,.90);
      font-weight: 1000;
    }
    .table td{
      background: rgba(245,247,246,.60);
      color: rgba(24,32,24,.82);
      font-weight: 900;
    }
    .table tr:last-child td{ border-bottom:none; }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(13,59,102,.14);
      background: rgba(255,255,255,.86);
      font-weight: 1000;
      font-size: 12px;
      color: rgba(13,59,102,.92);
      white-space: nowrap;
    }
    .chip.good{
      border-color: rgba(76,175,143,.28);
      background: rgba(76,175,143,.14);
      color: #0c4d44;
    }
    .chip.warn{
      border-color: rgba(242,201,76,.40);
      background: rgba(242,201,76,.16);
      color: rgba(91,74,18,.95);
    }

    .searchbar{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      margin: 10px 0 12px;
    }
    .input{
      flex: 1 1 240px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(13,59,102,.14);
      background: rgba(242,246,255,.55);
      outline: none;
      font-weight: 900;
    }
    .input:focus{
      border-color: rgba(76,175,143,.42);
      box-shadow: 0 0 0 4px rgba(76,175,143,.14);
      background: rgba(242,246,255,.80);
    }
    .select{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(13,59,102,.14);
      background: rgba(255,255,255,.92);
      font-weight: 900;
      cursor:pointer;
    }
    textarea.input{ min-height: 84px; resize: vertical; line-height: 1.35; }

    .btn{
      border: 1px solid rgba(13,59,102,.18);
      background: rgba(255,255,255,.92);
      color: rgba(13,59,102,.92);
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 1000;
      cursor: pointer;
      font-size: 12.5px;
      white-space: nowrap;
    }
    .btn.primary{
      border: 1px solid rgba(76,175,143,.28);
      background: rgba(76,175,143,.14);
      color: #0c4d44;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .row-actions{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
      margin-top: 10px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 860px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .materials{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 980px){
      .materials{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 560px){
      .materials{ grid-template-columns: 1fr; }
    }
    .mcard{
      border: 1px solid rgba(13,59,102,.10);
      background: rgba(245,247,246,.70);
      border-radius: 16px;
      padding: 10px;
    }
    .mcard .head{
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      font-weight: 1000;
      color: rgba(13,59,102,.92);
      margin-bottom: 8px;
      font-size: 12.5px;
    }
    .mcard input{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(13,59,102,.14);
      background: rgba(255,255,255,.92);
      outline:none;
      font-weight: 1000;
    }
    .mcard input:focus{
      border-color: rgba(76,175,143,.42);
      box-shadow: 0 0 0 4px rgba(76,175,143,.14);
    }

    .notice{
      border: 1px solid rgba(13,59,102,.10);
      background: rgba(245,247,246,.70);
      border-radius: 16px;
      padding: 12px;
      margin-top: 10px;
    }
    .notice h3{
      margin:0 0 6px;
      font-family: Poppins, Inter, sans-serif;
      font-size: 14px;
      letter-spacing: -.02em;
    }
    .notice p{
      margin: 0;
      font-size: 12.5px;
      font-weight: 900;
      color: rgba(24,32,24,.72);
      line-height: 1.45;
      white-space: pre-line;
    }
    .notice .meta{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }

    .track{
      border: 1px solid rgba(13,59,102,.10);
      background: rgba(245,247,246,.70);
      border-radius: 16px;
      padding: 12px;
      margin-top: 10px;
    }
    .track h3{
      margin:0 0 6px;
      font-family: Poppins, Inter, sans-serif;
      font-size: 14px;
      letter-spacing: -.02em;
    }
    .track p{
      margin: 0;
      font-size: 12.5px;
      font-weight: 900;
      color: rgba(24,32,24,.72);
      line-height: 1.45;
      white-space: pre-line;
    }
    .track .meta{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .track a{
      font-weight: 1000;
      color: rgba(13,59,102,.92);
      text-decoration: none;
      border-bottom: 1px dashed rgba(13,59,102,.35);
    }

    .muted-note{
      margin-top: 10px;
      font-size: 12px;
      font-weight: 900;
      color: rgba(24,32,24,.60);
      line-height: 1.45;
    }

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      max-width: 520px;
      z-index: 99;
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(13,59,102,.12);
      box-shadow: 0 18px 50px rgba(13,59,102,.14);
      border-radius: 16px;
      padding: 10px 12px;
      display:none;
      font-weight: 900;
      color: rgba(24,32,24,.80);
      white-space: pre-line;
    }
    .toast.show{ display:block; }

    .mini{
      font-size: 12px;
      font-weight: 900;
      color: rgba(24,32,24,.62);
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">‚ôªÔ∏è</div>
        <div>
          <strong>Plataforma Regenera</strong>
          <span id="hdrSubtitle">Cooperativa ‚Ä¢ Carregando...</span>
        </div>
      </div>

      <div class="actions">
        <span class="badge" id="badgeTerritory">Territ√≥rio: ‚Äî</span>
        <span class="badge neutral" id="badgeUser">‚Äî</span>
        <button class="pill" id="btnRefresh" type="button">üîÑ <span>Atualizar</span></button>
        <button class="pill" id="btnLogout" type="button">üö™ <span>Sair</span></button>
      </div>
    </div>
  </header>

  <main class="layout">
    <aside class="sidebar">
      <div class="nav-title">Menu cooperativa</div>
      <nav class="nav">
        <button data-section="dashboard" class="active">
          <span>üìå Vis√£o geral</span><small>indicadores</small>
        </button>
        <button data-section="crgr">
          <span>üè† CRGR</span><small>informa√ß√µes</small>
        </button>
        <button data-section="input">
          <span>üßæ Input de dados</span><small>triagem + BI</small>
        </button>
        <button data-section="indicators">
          <span>üìä Indicadores</span><small>por material</small>
        </button>
        <button data-section="notices">
          <span>üì£ Avisos</span><small>comunicados</small>
        </button>
        <button data-section="tracks">
          <span>üìö Trilhas</span><small>capacita√ß√£o</small>
        </button>
        <button data-section="profile">
          <span>üë§ Meu perfil</span><small>dados</small>
        </button>
      </nav>

      <p class="muted-note">
        Entrada permitida apenas para <b>cooperativa</b> com <b>status=active</b>. Voc√™ v√™ dados do seu territ√≥rio.
      </p>
    </aside>

    <section class="content">
      <!-- DASHBOARD -->
      <div id="section-dashboard" class="section active">
        <div class="card">
          <h2>
            <span>Vis√£o geral</span>
            <span class="chip good" id="chipReady">üü¢ pronto</span>
          </h2>
          <p class="sub">
            Painel simples e transparente: volume total, destaque por material e √∫ltimos registros.
          </p>

          <div class="kpi">
            <div class="box">
              <b id="kpiTotal30">0</b>
              <span>Triado (√∫ltimos 30 dias) ‚Ä¢ kg</span>
            </div>
            <div class="box">
              <b id="kpiTopMaterial">‚Äî</b>
              <span>Material destaque (30 dias)</span>
            </div>
            <div class="box">
              <b id="kpiEntries">0</b>
              <span>Registros (√∫ltimos 30 dias)</span>
            </div>
          </div>

          <div class="muted-note" id="dashHint">
            Dica: registre a triagem diariamente em <b>Input de dados</b>.
          </div>
        </div>

        <div class="card">
          <h2>
            <span>√öltimos registros</span>
            <span class="chip" id="chipLast">üßæ 0</span>
          </h2>

          <table class="table">
            <thead>
              <tr>
                <th>Data</th>
                <th>Turno</th>
                <th>Total (kg)</th>
                <th>Observa√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tbodyLastLogs">
              <tr><td colspan="4" class="mini">Carregando‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- CRGR INFO -->
      <div id="section-crgr" class="section">
        <div class="card">
          <h2>
            <span>Informa√ß√µes gerais da CRGR</span>
            <span class="chip" id="chipCrgr">üè†</span>
          </h2>
          <p class="sub">Informa√ß√µes do seu territ√≥rio (hor√°rios, contatos, descri√ß√£o, links).</p>

          <table class="table">
            <tbody>
              <tr><th style="width:220px;">Territ√≥rio</th><td id="crgrName">‚Äî</td></tr>
              <tr><th>Cidade/UF</th><td id="crgrPlace">‚Äî</td></tr>
              <tr><th>CRC / CRGR</th><td id="crgrCrc">‚Äî</td></tr>
              <tr><th>C√≥digo</th><td id="crgrCode">‚Äî</td></tr>
              <tr><th>Descri√ß√£o</th><td id="crgrDesc">‚Äî</td></tr>
              <tr><th>Contatos</th><td id="crgrContacts">‚Äî</td></tr>
              <tr><th>Links</th><td id="crgrLinks">‚Äî</td></tr>
            </tbody>
          </table>

          <p class="muted-note">
            A governan√ßa pode atualizar esses dados em <b>Territ√≥rios</b>.
          </p>
        </div>
      </div>

      <!-- INPUT -->
      <div id="section-input" class="section">

        <!-- POWERBI-LIKE DASHBOARD -->
        <div class="card" style="margin-bottom:14px;">
          <h2>
            <span>Dashboard ‚Ä¢ Input (PowerBI-like)</span>
            <span class="chip" id="chipDash">üìä</span>
          </h2>
          <p class="sub">
            Filtros + KPIs + gr√°ficos alimentados pelos registros em <b>daily_logs</b>.
          </p>

          <!-- Slicers -->
          <div class="searchbar">
            <label class="mini"><b>De</b><br>
              <input id="dashFrom" class="input" type="date" style="min-width:210px;">
            </label>

            <label class="mini"><b>At√©</b><br>
              <input id="dashTo" class="input" type="date" style="min-width:210px;">
            </label>

            <label class="mini"><b>Turno</b><br>
              <select id="dashShift" class="select" style="min-width:210px;">
                <option value="">Todos</option>
                <option value="manha">Manh√£</option>
                <option value="tarde">Tarde</option>
                <option value="noite">Noite</option>
                <option value="integral">Integral</option>
              </select>
            </label>

            <label class="mini"><b>Material</b><br>
              <select id="dashMaterial" class="select" style="min-width:260px;">
                <option value="">Todos</option>
              </select>
            </label>

            <button class="btn" id="btnDashApply" type="button">Aplicar</button>
            <button class="btn" id="btnDashReset" type="button">Reset</button>
          </div>

          <!-- KPI cards -->
          <div class="kpi" style="grid-template-columns: repeat(4, minmax(0,1fr));">
            <div class="box">
              <b id="dashKpiTotal">0</b>
              <span>Total triado (kg)</span>
            </div>
            <div class="box">
              <b id="dashKpiEntries">0</b>
              <span>N¬∫ de registros</span>
            </div>
            <div class="box">
              <b id="dashKpiAvgDay">0</b>
              <span>M√©dia por dia (kg)</span>
            </div>
            <div class="box">
              <b id="dashKpiTop">‚Äî</b>
              <span>Top material</span>
            </div>
          </div>

          <!-- Charts grid -->
          <div class="grid2" style="margin-top:12px;">
            <div class="mcard" style="background:#fff;">
              <div class="head"><span>üìà Total por dia</span><span class="chip" id="chipLine">line</span></div>
              <canvas id="chartLine" height="140"></canvas>
            </div>

            <div class="mcard" style="background:#fff;">
              <div class="head"><span>üç© Participa√ß√£o por material</span><span class="chip" id="chipDonut">donut</span></div>
              <canvas id="chartDonut" height="140"></canvas>
            </div>
          </div>

          <div class="mcard" style="background:#fff; margin-top:10px;">
            <div class="head"><span>üìä Triagem por material (kg)</span><span class="chip" id="chipBar">bar</span></div>
            <canvas id="chartBar" height="120"></canvas>
          </div>

          <p class="muted-note">
            Esse dashboard fica ‚ÄúPowerBI-like‚Äù: voc√™ filtra e os visuais mudam na hora.
          </p>
        </div>

        <!-- FORM -->
        <div class="card">
          <h2>
            <span>Input de dados ‚Ä¢ Triagem (recicl√°veis)</span>
            <span class="chip" id="chipInput">üßæ di√°rio</span>
          </h2>
          <p class="sub">
            Preencha o que foi triado no dia. Somente <b>recicl√°veis</b>.
          </p>

          <div class="grid2">
            <div>
              <label class="mini" for="logDate"><b>Data *</b></label>
              <input id="logDate" class="input" type="date">
            </div>
            <div>
              <label class="mini" for="logShift"><b>Turno</b></label>
              <select id="logShift" class="select" style="width:100%;">
                <option value="manha">Manh√£</option>
                <option value="tarde">Tarde</option>
                <option value="noite">Noite</option>
                <option value="integral">Integral</option>
              </select>
            </div>
          </div>

          <div class="materials" id="materialsGrid"></div>

          <div style="margin-top:10px;">
            <label class="mini" for="logNotes"><b>Observa√ß√µes (gargalos / avisos do dia)</b></label>
            <textarea id="logNotes" class="input" placeholder="Ex: faltou big bag, material acumulado, problema na prensa..."></textarea>
          </div>

          <div class="row-actions">
            <span class="badge neutral" id="badgeSum">Total: 0 kg</span>
            <button class="btn" id="btnClear" type="button">üßπ Limpar</button>
            <button class="btn primary" id="btnSave" type="button">üíæ Salvar registro</button>
          </div>

          <p class="muted-note" id="writeHint">
            Se aparecer erro de permiss√£o ao salvar, falta liberar a collection <b>daily_logs</b> nas rules.
          </p>
        </div>

        <div class="card">
          <h2>
            <span>Hist√≥rico recente</span>
            <span class="chip" id="chipHistory">üóÇÔ∏è 0</span>
          </h2>

          <table class="table">
            <thead>
              <tr>
                <th>Data</th>
                <th>Turno</th>
                <th>Total (kg)</th>
                <th>Top materiais</th>
              </tr>
            </thead>
            <tbody id="tbodyHistory">
              <tr><td colspan="4" class="mini">Carregando‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- INDICATORS -->
      <div id="section-indicators" class="section">
        <div class="card">
          <h2>
            <span>Indicadores por material</span>
            <span class="chip" id="chipInd">üìä 30d</span>
          </h2>
          <p class="sub">
            Somat√≥rio por material (√∫ltimos 30 dias).
          </p>

          <table class="table">
            <thead>
              <tr>
                <th>Material</th>
                <th>Total (kg)</th>
                <th>% do total</th>
              </tr>
            </thead>
            <tbody id="tbodyAgg">
              <tr><td colspan="3" class="mini">Carregando‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- NOTICES -->
      <div id="section-notices" class="section">
        <div class="card">
          <h2>
            <span>Avisos & Comunicados</span>
            <span class="chip" id="chipNotices">üì£ 0</span>
          </h2>
          <p class="sub">Comunicados do seu territ√≥rio e gerais.</p>

          <div class="searchbar">
            <input id="nSearch" class="input" placeholder="Buscar aviso...">
          </div>

          <div id="noticesList">
            <div class="mini">Carregando‚Ä¶</div>
          </div>
        </div>
      </div>

      <!-- TRACKS -->
      <div id="section-tracks" class="section">
        <div class="card">
          <h2>
            <span>Trilhas de capacita√ß√£o</span>
            <span class="chip" id="chipTracks">üìö 0</span>
          </h2>
          <p class="sub">
            Conte√∫dos do territ√≥rio e materiais gerais.
          </p>

          <div class="searchbar">
            <input id="trSearch" class="input" placeholder="Buscar conte√∫do...">
            <select id="trLevel" class="select">
              <option value="">Todos n√≠veis</option>
              <option value="iniciante">Iniciante</option>
              <option value="operacional">Operacional</option>
              <option value="gestao">Gest√£o</option>
            </select>
          </div>

          <div id="tracksList">
            <div class="mini">Carregando‚Ä¶</div>
          </div>
        </div>
      </div>

      <!-- PROFILE -->
      <div id="section-profile" class="section">
        <div class="card">
          <h2>
            <span>Meu perfil</span>
            <span class="chip" id="chipStatus">‚Äî</span>
          </h2>

          <table class="table">
            <tbody>
              <tr><th style="width:180px;">Nome</th><td id="pName">‚Äî</td></tr>
              <tr><th>E-mail</th><td id="pEmail">‚Äî</td></tr>
              <tr><th>Role</th><td id="pRole">‚Äî</td></tr>
              <tr><th>Territ√≥rio</th><td id="pTerr">‚Äî</td></tr>
              <tr><th>UID</th><td id="pUid">‚Äî</td></tr>
            </tbody>
          </table>

          <p class="muted-note">
            Para alterar territ√≥rio/status, solicite √† governan√ßa.
          </p>
        </div>
      </div>

    </section>
  </main>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { auth, db } from "./assets/firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      collection,
      doc,
      getDoc,
      query,
      where,
      limit,
      onSnapshot,
      addDoc,
      serverTimestamp,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ========= UI: menu/sections =========
    const navButtons = Array.from(document.querySelectorAll(".nav button[data-section]"));
    const sections = Array.from(document.querySelectorAll(".section"));
    function setSection(key){
      navButtons.forEach(b => b.classList.toggle("active", b.dataset.section === key));
      sections.forEach(s => s.classList.toggle("active", s.id === `section-${key}`));
    }
    navButtons.forEach(b => b.addEventListener("click", () => setSection(b.dataset.section)));

    // ========= Toast =========
    const toast = document.getElementById("toast");
    function notify(text){
      toast.textContent = text;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2800);
    }

    // ========= Helpers =========
    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }
    function norm(v){ return String(v ?? "").trim(); }
    function lower(v){ return norm(v).toLowerCase(); }
    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function tsToMillis(t){
      if (!t) return 0;
      if (typeof t.toMillis === "function") return t.toMillis();
      if (typeof t.seconds === "number") return (t.seconds * 1000) + Math.floor((t.nanoseconds||0)/1e6);
      const d = new Date(t);
      const ms = d.getTime();
      return Number.isFinite(ms) ? ms : 0;
    }
    function isoDaysAgo(n){
      const d = new Date();
      d.setDate(d.getDate() - n);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    // ========= Header =========
    const hdrSubtitle = document.getElementById("hdrSubtitle");
    const badgeTerritory = document.getElementById("badgeTerritory");
    const badgeUser = document.getElementById("badgeUser");
    const btnLogout = document.getElementById("btnLogout");
    const btnRefresh = document.getElementById("btnRefresh");

    function goLogin(){ window.location.href = "login.html"; }
    btnLogout?.addEventListener("click", async () => { try{ await signOut(auth);} finally{ goLogin(); } });

    // ========= Profile =========
    const chipStatus = document.getElementById("chipStatus");
    const pName = document.getElementById("pName");
    const pEmail = document.getElementById("pEmail");
    const pRole = document.getElementById("pRole");
    const pTerr = document.getElementById("pTerr");
    const pUid = document.getElementById("pUid");

    // ========= CRGR =========
    const crgrName = document.getElementById("crgrName");
    const crgrPlace = document.getElementById("crgrPlace");
    const crgrCrc = document.getElementById("crgrCrc");
    const crgrCode = document.getElementById("crgrCode");
    const crgrDesc = document.getElementById("crgrDesc");
    const crgrContacts = document.getElementById("crgrContacts");
    const crgrLinks = document.getElementById("crgrLinks");

    // ========= Dashboard KPIs =========
    const kpiTotal30 = document.getElementById("kpiTotal30");
    const kpiTopMaterial = document.getElementById("kpiTopMaterial");
    const kpiEntries = document.getElementById("kpiEntries");
    const chipLast = document.getElementById("chipLast");
    const tbodyLastLogs = document.getElementById("tbodyLastLogs");
    const tbodyHistory = document.getElementById("tbodyHistory");
    const chipHistory = document.getElementById("chipHistory");
    const tbodyAgg = document.getElementById("tbodyAgg");

    // ========= Input =========
    const logDate = document.getElementById("logDate");
    const logShift = document.getElementById("logShift");
    const logNotes = document.getElementById("logNotes");
    const materialsGrid = document.getElementById("materialsGrid");
    const badgeSum = document.getElementById("badgeSum");
    const btnClear = document.getElementById("btnClear");
    const btnSave = document.getElementById("btnSave");

    // ========= Notices =========
    const chipNotices = document.getElementById("chipNotices");
    const nSearch = document.getElementById("nSearch");
    const noticesList = document.getElementById("noticesList");

    // ========= Tracks/Contents =========
    const chipTracks = document.getElementById("chipTracks");
    const trSearch = document.getElementById("trSearch");
    const trLevel = document.getElementById("trLevel");
    const tracksList = document.getElementById("tracksList");

    // ========= Materiais recicl√°veis (somente) =========
    const RECYCLABLES = [
      { key:"papel", label:"Papel (branco/misto)" },
      { key:"papelao", label:"Papel√£o" },
      { key:"plastico_rigido", label:"Pl√°stico r√≠gido" },
      { key:"pet", label:"PET" },
      { key:"pead", label:"PEAD" },
      { key:"filme", label:"Pl√°stico filme" },
      { key:"aluminio", label:"Alum√≠nio" },
      { key:"aco", label:"A√ßo / ferro" },
      { key:"vidro", label:"Vidro" },
      { key:"tetrapak", label:"Longa vida (Tetra Pak)" },
      { key:"outros_reciclaveis", label:"Outros recicl√°veis" }
    ];

    function buildMaterialsUI(){
      materialsGrid.innerHTML = RECYCLABLES.map(m => `
        <div class="mcard" data-mkey="${esc(m.key)}">
          <div class="head">
            <span>${esc(m.label)}</span>
            <span class="chip" id="chip_${esc(m.key)}">0 kg</span>
          </div>
          <input inputmode="decimal" placeholder="kg (ex: 120.5)" id="kg_${esc(m.key)}">
        </div>
      `).join("");

      for (const m of RECYCLABLES){
        const el = document.getElementById(`kg_${m.key}`);
        el.addEventListener("input", () => {
          const v = parseKg(el.value);
          document.getElementById(`chip_${m.key}`).textContent = `${fmtKg(v)} kg`;
          updateSum();
        });
      }
      updateSum();
    }

    function parseKg(v){
      const s = String(v ?? "").replace(",", ".").replace(/[^\d.]/g, "");
      const n = Number(s);
      return Number.isFinite(n) ? Math.max(0, n) : 0;
    }
    function fmtKg(n){
      const x = Math.round((Number(n)||0) * 10) / 10;
      return x.toFixed(x % 1 === 0 ? 0 : 1);
    }

    function collectItems(){
      const items = [];
      for (const m of RECYCLABLES){
        const kg = parseKg(document.getElementById(`kg_${m.key}`).value);
        if (kg > 0) items.push({ materialKey: m.key, materialLabel: m.label, kg });
      }
      return items;
    }

    function updateSum(){
      const items = collectItems();
      const total = items.reduce((acc, it) => acc + (Number(it.kg)||0), 0);
      badgeSum.textContent = `Total: ${fmtKg(total)} kg`;
    }

    function clearForm(){
      logDate.value = todayISO();
      logShift.value = "manha";
      logNotes.value = "";
      for (const m of RECYCLABLES){
        document.getElementById(`kg_${m.key}`).value = "";
        document.getElementById(`chip_${m.key}`).textContent = `0 kg`;
      }
      updateSum();
    }

    btnClear.addEventListener("click", clearForm);

    // ========= State =========
    let myUid = null;
    let myTerritoryId = null;
    let myUser = null;
    let myTerritory = null;

    let unsubLogs = null;
    let logsCache = []; // {id,data}
    let unsubNoticesA = null;
    let unsubNoticesB = null;
    let noticesCache = []; // merged
    let unsubContentsA = null;
    let unsubContentsB = null;
    let contentsCache = []; // merged

    function stopAll(){
      if (typeof unsubLogs === "function") unsubLogs();
      if (typeof unsubNoticesA === "function") unsubNoticesA();
      if (typeof unsubNoticesB === "function") unsubNoticesB();
      if (typeof unsubContentsA === "function") unsubContentsA();
      if (typeof unsubContentsB === "function") unsubContentsB();
      unsubLogs = unsubNoticesA = unsubNoticesB = unsubContentsA = unsubContentsB = null;
    }

    function renderEmpty(tbody, colSpan, text){
      tbody.innerHTML = `<tr><td colspan="${colSpan}" class="mini">${esc(text)}</td></tr>`;
    }

    function logTotalKg(log){
      const items = Array.isArray(log.items) ? log.items : [];
      return items.reduce((acc, it) => acc + (Number(it.kg)||0), 0);
    }

    function topMaterialsText(log, n=3){
      const items = (Array.isArray(log.items) ? log.items : [])
        .slice()
        .sort((a,b) => (Number(b.kg)||0) - (Number(a.kg)||0))
        .slice(0,n)
        .map(it => `${it.materialLabel || it.materialKey}: ${fmtKg(it.kg)}kg`);
      return items.length ? items.join(" ‚Ä¢ ") : "‚Äî";
    }

    // ========= POWERBI-LIKE DASHBOARD =========
    const dashFrom = document.getElementById("dashFrom");
    const dashTo = document.getElementById("dashTo");
    const dashShift = document.getElementById("dashShift");
    const dashMaterial = document.getElementById("dashMaterial");
    const btnDashApply = document.getElementById("btnDashApply");
    const btnDashReset = document.getElementById("btnDashReset");
    const chipDash = document.getElementById("chipDash");

    const dashKpiTotal = document.getElementById("dashKpiTotal");
    const dashKpiEntries = document.getElementById("dashKpiEntries");
    const dashKpiAvgDay = document.getElementById("dashKpiAvgDay");
    const dashKpiTop = document.getElementById("dashKpiTop");

    let chartLine = null;
    let chartBar = null;
    let chartDonut = null;

    function fmt1(n){
      const x = Math.round((Number(n)||0) * 10)/10;
      return x % 1 === 0 ? String(x.toFixed(0)) : String(x.toFixed(1));
    }
    function ensureChartLib(){
      if (!window.Chart){
        notify("Chart.js n√£o carregou. Verifique internet/CDN.");
        return false;
      }
      return true;
    }
    function uniq(arr){ return Array.from(new Set(arr)); }
    function dateInRange(d, from, to){
      if (from && d < from) return false;
      if (to && d > to) return false;
      return true;
    }

    function buildMaterialSlicerOptions(){
      const mats = [];
      for (const x of logsCache){
        const items = Array.isArray(x.data?.items) ? x.data.items : [];
        for (const it of items){
          if (it?.materialKey) mats.push(it.materialKey);
        }
      }
      const u = uniq(mats).sort((a,b)=> String(a).localeCompare(String(b)));
      const sel = dashMaterial.value || "";
      dashMaterial.innerHTML = `<option value="">Todos</option>` + u.map(k => {
        const label = (RECYCLABLES.find(m => m.key === k)?.label) || k;
        return `<option value="${esc(k)}">${esc(label)}</option>`;
      }).join("");
      dashMaterial.value = u.includes(sel) ? sel : "";
    }

    function getFilteredLogs(){
      const from = dashFrom.value ? dashFrom.value : "";
      const to = dashTo.value ? dashTo.value : "";
      const shift = (dashShift.value || "").trim().toLowerCase();
      const mat = (dashMaterial.value || "").trim();

      const filtered = logsCache
        .map(x => x.data)
        .filter(d => d && d.date)
        .filter(d => dateInRange(String(d.date), from, to))
        .filter(d => !shift || String(d.shift||"").toLowerCase() === shift)
        .map(d => {
          if (!mat) return d;
          const items = (Array.isArray(d.items) ? d.items : []).filter(it => it.materialKey === mat);
          const totalKg = items.reduce((a,it)=> a + (Number(it.kg)||0), 0);
          return { ...d, items, totalKg };
        })
        .filter(d => {
          if (!mat) return true;
          return (Number(d.totalKg)||0) > 0;
        });

      return filtered;
    }

    function aggByDay(logs){
      const map = new Map();
      for (const d of logs){
        const key = String(d.date);
        const total = Number(d.totalKg ?? logTotalKg(d)) || 0;
        map.set(key, (map.get(key) || 0) + total);
      }
      const days = Array.from(map.entries()).sort((a,b)=> a[0].localeCompare(b[0]));
      return { labels: days.map(x=>x[0]), values: days.map(x=>x[1]) };
    }

    function aggByMaterial(logs){
      const map = new Map();
      for (const d of logs){
        const items = Array.isArray(d.items) ? d.items : [];
        for (const it of items){
          const key = it.materialKey || it.materialLabel || "outro";
          const label =
            it.materialLabel ||
            (RECYCLABLES.find(m => m.key === key)?.label) ||
            it.materialKey ||
            "Outro";
          const kg = Number(it.kg)||0;
          const prev = map.get(key) || { key, label, kg: 0 };
          prev.kg += kg;
          map.set(key, prev);
        }
      }
      return Array.from(map.values()).sort((a,b)=> b.kg - a.kg);
    }

    function setKpisDash(logs){
      const total = logs.reduce((a,d)=> a + (Number(d.totalKg ?? logTotalKg(d))||0), 0);
      const entries = logs.length;

      const dayAgg = aggByDay(logs);
      const daysCount = dayAgg.labels.length || 0;
      const avgDay = daysCount ? (total / daysCount) : 0;

      const mats = aggByMaterial(logs);
      const top = mats[0];

      dashKpiTotal.textContent = fmt1(total);
      dashKpiEntries.textContent = String(entries);
      dashKpiAvgDay.textContent = fmt1(avgDay);
      dashKpiTop.textContent = top ? `${top.label} (${fmt1(top.kg)}kg)` : "‚Äî";

      chipDash.textContent = `üìä ${entries} regs`;
    }

    function destroyCharts(){
      if (chartLine) { chartLine.destroy(); chartLine = null; }
      if (chartBar) { chartBar.destroy(); chartBar = null; }
      if (chartDonut) { chartDonut.destroy(); chartDonut = null; }
    }

    function renderCharts(logs){
      if (!ensureChartLib()) return;

      const byDay = aggByDay(logs);
      const mats = aggByMaterial(logs);

      const ctxLine = document.getElementById("chartLine");
      const ctxBar = document.getElementById("chartBar");
      const ctxDonut = document.getElementById("chartDonut");

      destroyCharts();

      chartLine = new Chart(ctxLine, {
        type: "line",
        data: {
          labels: byDay.labels,
          datasets: [{ label: "Total (kg)", data: byDay.values }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      const matsTop = mats.slice(0, 12);
      chartBar = new Chart(ctxBar, {
        type: "bar",
        data: {
          labels: matsTop.map(m => m.label),
          datasets: [{ label: "kg", data: matsTop.map(m => m.kg) }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      const top8 = mats.slice(0, 8);
      const rest = mats.slice(8).reduce((a,m)=> a + m.kg, 0);
      const donutLabels = top8.map(m=>m.label).concat(rest > 0 ? ["Outros"] : []);
      const donutValues = top8.map(m=>m.kg).concat(rest > 0 ? [rest] : []);

      chartDonut = new Chart(ctxDonut, {
        type: "doughnut",
        data: { labels: donutLabels, datasets: [{ data: donutValues }] },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } }
        }
      });
    }

    function dashApply(){
      const logs = getFilteredLogs();
      setKpisDash(logs);
      renderCharts(logs);
    }

    function dashReset(){
      dashFrom.value = isoDaysAgo(30);
      dashTo.value = todayISO();
      dashShift.value = "";
      dashMaterial.value = "";
      dashApply();
    }

    btnDashApply.addEventListener("click", dashApply);
    btnDashReset.addEventListener("click", dashReset);

    function refreshDashboardFromLogs(){
      buildMaterialSlicerOptions();
      if (!dashFrom.value && !dashTo.value){
        dashFrom.value = isoDaysAgo(30);
        dashTo.value = todayISO();
      }
      dashApply();
    }

    // ========= Logs render (tabelas + KPIs gerais) =========
    function renderLogs(){
      logsCache.sort((a,b) => String(b.data.date || "").localeCompare(String(a.data.date || "")));

      const last5 = logsCache.slice(0, 5);
      chipLast.textContent = `üßæ ${last5.length}`;

      if (last5.length === 0){
        renderEmpty(tbodyLastLogs, 4, "Nenhum registro ainda.");
      } else {
        tbodyLastLogs.innerHTML = last5.map(x => {
          const d = x.data || {};
          const total = fmtKg(logTotalKg(d));
          return `
            <tr>
              <td>${esc(d.date || "‚Äî")}</td>
              <td>${esc(d.shift || "‚Äî")}</td>
              <td>${esc(total)} kg</td>
              <td>${esc(d.notes || "‚Äî")}</td>
            </tr>
          `;
        }).join("");
      }

      const hist = logsCache.slice(0, 12);
      chipHistory.textContent = `üóÇÔ∏è ${hist.length}`;

      if (hist.length === 0){
        renderEmpty(tbodyHistory, 4, "Sem hist√≥rico ainda.");
      } else {
        tbodyHistory.innerHTML = hist.map(x => {
          const d = x.data || {};
          const total = fmtKg(logTotalKg(d));
          return `
            <tr>
              <td>${esc(d.date || "‚Äî")}</td>
              <td>${esc(d.shift || "‚Äî")}</td>
              <td>${esc(total)} kg</td>
              <td>${esc(topMaterialsText(d, 3))}</td>
            </tr>
          `;
        }).join("");
      }

      // KPIs vis√£o geral (30 dias)
      const start = isoDaysAgo(30);
      const logs30 = logsCache
        .map(x => x.data)
        .filter(d => d?.date && String(d.date) >= start);

      const total30 = logs30.reduce((acc, d) => acc + logTotalKg(d), 0);
      kpiTotal30.textContent = fmtKg(total30);

      const agg = new Map();
      for (const d of logs30){
        const items = Array.isArray(d.items) ? d.items : [];
        for (const it of items){
          const key = it.materialKey || it.materialLabel || "outro";
          const label = it.materialLabel || it.materialKey || "Outro";
          const kg = Number(it.kg)||0;
          const prev = agg.get(key) || { label, kg: 0 };
          prev.kg += kg;
          agg.set(key, prev);
        }
      }

      const aggArr = Array.from(agg.values()).sort((a,b) => b.kg - a.kg);
      const top = aggArr[0];
      kpiTopMaterial.textContent = top ? `${top.label} (${fmtKg(top.kg)}kg)` : "‚Äî";
      kpiEntries.textContent = String(logs30.length);

      if (aggArr.length === 0){
        renderEmpty(tbodyAgg, 3, "Sem dados nos √∫ltimos 30 dias.");
      } else {
        tbodyAgg.innerHTML = aggArr.map(r => {
          const pct = total30 > 0 ? Math.round((r.kg / total30) * 100) : 0;
          return `
            <tr>
              <td>${esc(r.label)}</td>
              <td>${esc(fmtKg(r.kg))} kg</td>
              <td>${esc(pct)}%</td>
            </tr>
          `;
        }).join("");
      }

      // Atualiza dashboard PowerBI-like
      refreshDashboardFromLogs();
    }

    function startLogs(){
      if (!myTerritoryId){
        logsCache = [];
        renderEmpty(tbodyLastLogs, 4, "Seu territoryId est√° vazio. Pe√ßa para a governan√ßa definir seu territ√≥rio.");
        renderEmpty(tbodyHistory, 4, "Seu territoryId est√° vazio. Pe√ßa para a governan√ßa definir seu territ√≥rio.");
        renderEmpty(tbodyAgg, 3, "Seu territoryId est√° vazio. Pe√ßa para a governan√ßa definir seu territ√≥rio.");
        kpiTotal30.textContent = "0";
        kpiTopMaterial.textContent = "‚Äî";
        kpiEntries.textContent = "0";
        refreshDashboardFromLogs();
        return;
      }

      const qL = query(collection(db, "daily_logs"), where("territoryId", "==", myTerritoryId), limit(800));
      unsubLogs = onSnapshot(qL, (snap) => {
        logsCache = [];
        snap.forEach(d => logsCache.push({ id: d.id, data: d.data() }));
        renderLogs();
      }, (err) => {
        console.error(err);
        renderEmpty(tbodyLastLogs, 4, `Erro: ${err.code || err.message}`);
        renderEmpty(tbodyHistory, 4, `Erro: ${err.code || err.message}`);
        renderEmpty(tbodyAgg, 3, `Erro: ${err.code || err.message}`);
      });
    }

    async function saveLog(){
      if (!myTerritoryId){
        alert("Seu territoryId est√° vazio. Pe√ßa para a governan√ßa definir seu territ√≥rio.");
        return;
      }

      const date = norm(logDate.value);
      if (!date){
        alert("Informe a data.");
        return;
      }

      const items = collectItems();
      const total = items.reduce((a,it)=> a + (Number(it.kg)||0), 0);
      if (total <= 0){
        alert("Preencha pelo menos um material (kg).");
        return;
      }

      btnSave.disabled = true;
      btnSave.textContent = "Salvando...";

      try{
        await addDoc(collection(db, "daily_logs"), {
          territoryId: myTerritoryId,
          date,
          shift: lower(logShift.value) || "manha",
          items,
          totalKg: total,
          notes: norm(logNotes.value) || null,
          createdBy: myUid,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        notify("Registro salvo ‚úÖ");
        clearForm();
      }catch(err){
        console.error(err);
        notify(`Erro ao salvar: ${err.code || err.message}`);
        alert(`Erro ao salvar: ${err.code || err.message}`);
      }finally{
        btnSave.disabled = false;
        btnSave.textContent = "üíæ Salvar registro";
      }
    }

    btnSave.addEventListener("click", saveLog);

    // ========= Notices =========
    function mergeById(list){
      const map = new Map();
      for (const x of list) map.set(x.id, x);
      return Array.from(map.values());
    }

    function renderNotices(){
      const s = lower(nSearch.value);
      const list = noticesCache
        .slice()
        .sort((a,b) => tsToMillis(b.data.createdAt) - tsToMillis(a.data.createdAt))
        .filter(x => {
          if (!s) return true;
          const d = x.data || {};
          return (
            lower(d.title).includes(s) ||
            lower(d.body).includes(s) ||
            lower(d.priority).includes(s)
          );
        });

      chipNotices.textContent = `üì£ ${list.length}`;

      if (list.length === 0){
        noticesList.innerHTML = `<div class="mini">Nenhum aviso (ou filtrado).</div>`;
        return;
      }

      noticesList.innerHTML = list.map(x => {
        const d = x.data || {};
        const pr = lower(d.priority || "normal");
        const prChip = pr === "alta" || pr === "high"
          ? `<span class="chip warn">‚ö†Ô∏è alta</span>`
          : `<span class="chip">üìå ${esc(pr || "normal")}</span>`;

        return `
          <div class="notice">
            <h3>${esc(d.title || "Aviso")}</h3>
            <p>${esc(d.body || "")}</p>
            <div class="meta">
              ${prChip}
              <span class="chip">${esc(d.territoryId ? "territ√≥rio" : "geral")}</span>
            </div>
          </div>
        `;
      }).join("");
    }

    function startNotices(){
      const qA = myTerritoryId
        ? query(collection(db, "notices"), where("territoryId", "==", myTerritoryId), limit(200))
        : null;

      const qB = query(collection(db, "notices"), where("territoryId", "==", null), limit(200));

      let aCache = [];
      let bCache = [];

      if (qA){
        unsubNoticesA = onSnapshot(qA, (snap) => {
          aCache = [];
          snap.forEach(d => aCache.push({ id: d.id, data: d.data() }));
          noticesCache = mergeById([...aCache, ...bCache]);
          renderNotices();
        }, (err) => {
          console.error(err);
          noticesList.innerHTML = `<div class="mini">Erro ao carregar avisos: ${esc(err.code || err.message)}</div>`;
        });
      } else {
        aCache = [];
      }

      unsubNoticesB = onSnapshot(qB, (snap) => {
        bCache = [];
        snap.forEach(d => bCache.push({ id: d.id, data: d.data() }));
        noticesCache = mergeById([...aCache, ...bCache]);
        renderNotices();
      }, (err) => {
        console.error(err);
        noticesList.innerHTML = `<div class="mini">Erro ao carregar avisos gerais: ${esc(err.code || err.message)}</div>`;
      });
    }

    nSearch.addEventListener("input", renderNotices);

    // ========= Contents/Tracks =========
    function renderTracks(){
      const s = lower(trSearch.value);
      const lv = lower(trLevel.value);

      const list = contentsCache
        .slice()
        .filter(x => {
          const d = x.data || {};
          const status = lower(d.status || "published");
          if (status !== "published") return false;

          const level = lower(d.level || d.nivel || "");
          if (lv && level !== lv) return false;

          if (!s) return true;
          return (
            lower(d.title).includes(s) ||
            lower(d.type).includes(s) ||
            lower(d.summary).includes(s) ||
            lower(d.body).includes(s)
          );
        })
        .sort((a,b) => tsToMillis(b.data.updatedAt || b.data.createdAt) - tsToMillis(a.data.updatedAt || a.data.createdAt));

      chipTracks.textContent = `üìö ${list.length}`;

      if (list.length === 0){
        tracksList.innerHTML = `<div class="mini">Nenhum conte√∫do (ou filtrado).</div>`;
        return;
      }

      tracksList.innerHTML = list.map(x => {
        const d = x.data || {};
        const type = d.type || "material";
        const level = d.level || d.nivel || "‚Äî";
        const link = d.url ? `<a href="${esc(d.url)}" target="_blank" rel="noopener noreferrer">Abrir</a>` : "";

        return `
          <div class="track">
            <h3>${esc(d.title || "Conte√∫do")}</h3>
            <p>${esc(d.summary || "")}</p>
            <div class="meta">
              <span class="chip">üìé ${esc(type)}</span>
              <span class="chip">üéØ ${esc(level)}</span>
              ${d.territoryId ? `<span class="chip">üó∫Ô∏è territ√≥rio</span>` : `<span class="chip">üåç geral</span>`}
              ${link ? `<span class="chip">${link}</span>` : ""}
            </div>
          </div>
        `;
      }).join("");
    }

    function startContents(){
      const qA = myTerritoryId
        ? query(collection(db, "contents"), where("territoryId", "==", myTerritoryId), limit(400))
        : null;

      const qB = query(collection(db, "contents"), where("territoryId", "==", null), limit(400));

      let aCache = [];
      let bCache = [];

      if (qA){
        unsubContentsA = onSnapshot(qA, (snap) => {
          aCache = [];
          snap.forEach(d => aCache.push({ id: d.id, data: d.data() }));
          contentsCache = mergeById([...aCache, ...bCache]);
          renderTracks();
        }, (err) => {
          console.error(err);
          tracksList.innerHTML = `<div class="mini">Erro ao carregar conte√∫dos do territ√≥rio: ${esc(err.code || err.message)}</div>`;
        });
      } else {
        aCache = [];
      }

      unsubContentsB = onSnapshot(qB, (snap) => {
        bCache = [];
        snap.forEach(d => bCache.push({ id: d.id, data: d.data() }));
        contentsCache = mergeById([...aCache, ...bCache]);
        renderTracks();
      }, (err) => {
        console.error(err);
        tracksList.innerHTML = `<div class="mini">Erro ao carregar conte√∫dos gerais: ${esc(err.code || err.message)}</div>`;
      });
    }

    trSearch.addEventListener("input", renderTracks);
    trLevel.addEventListener("change", renderTracks);

    // ========= CRGR render =========
    function renderCRGR(){
      if (!myTerritory){
        crgrName.textContent = "‚Äî";
        crgrPlace.textContent = "‚Äî";
        crgrCrc.textContent = "‚Äî";
        crgrCode.textContent = "‚Äî";
        crgrDesc.textContent = "‚Äî";
        crgrContacts.textContent = "‚Äî";
        crgrLinks.textContent = "‚Äî";
        return;
      }

      const t = myTerritory || {};
      crgrName.textContent = t.name || myTerritoryId || "‚Äî";
      crgrPlace.textContent = [t.city, t.state].filter(Boolean).join(" / ") || "‚Äî";
      crgrCrc.textContent = t.crcName || "‚Äî";
      crgrCode.textContent = t.code || "‚Äî";
      crgrDesc.textContent = t.description || t.desc || "‚Äî";

      const contacts = t.contacts || t.contatos || null;
      if (contacts && typeof contacts === "object"){
        const lines = [];
        for (const [k,v] of Object.entries(contacts)){
          if (v) lines.push(`${k}: ${v}`);
        }
        crgrContacts.textContent = lines.length ? lines.join(" ‚Ä¢ ") : "‚Äî";
      } else {
        crgrContacts.textContent = contacts ? String(contacts) : "‚Äî";
      }

      const links = t.links || t.linhas || t.urls || null;
      if (Array.isArray(links)){
        crgrLinks.innerHTML = links.length
          ? links.map(u => `<a href="${esc(u)}" target="_blank" rel="noopener noreferrer">${esc(u)}</a>`).join("<br>")
          : "‚Äî";
      } else if (links && typeof links === "object"){
        const lines = [];
        for (const [k,v] of Object.entries(links)){
          if (v) lines.push(`<a href="${esc(v)}" target="_blank" rel="noopener noreferrer">${esc(k)}</a>`);
        }
        crgrLinks.innerHTML = lines.length ? lines.join("<br>") : "‚Äî";
      } else {
        crgrLinks.textContent = links ? String(links) : "‚Äî";
      }
    }

    async function loadTerritory(){
      if (!myTerritoryId) {
        myTerritory = null;
        renderCRGR();
        return;
      }
      const tsnap = await getDoc(doc(db, "territories", myTerritoryId));
      myTerritory = tsnap.exists() ? (tsnap.data() || {}) : null;
      renderCRGR();
    }

    // ========= Refresh manual =========
    async function manualRefresh(){
      try{
        notify("Atualizando‚Ä¶");
        await loadTerritory();

        if (myTerritoryId){
          const snap = await getDocs(query(collection(db, "daily_logs"), where("territoryId", "==", myTerritoryId), limit(800)));
          logsCache = [];
          snap.forEach(d => logsCache.push({ id: d.id, data: d.data() }));
          renderLogs();
        }
        renderNotices();
        renderTracks();

        notify("Atualizado ‚úÖ");
      }catch(err){
        console.error(err);
        notify(`Erro: ${err.code || err.message}`);
      }
    }
    btnRefresh.addEventListener("click", manualRefresh);

    // ========= Guard coop only =========
    onAuthStateChanged(auth, async (user) => {
      if (!user) return goLogin();

      const snap = await getDoc(doc(db, "users", user.uid));
      if (!snap.exists()) return goLogin();

      const profile = snap.data() || {};
      const status = lower(profile.status);
      const role = lower(profile.role);

      if (status !== "active") return goLogin();
      if (role !== "cooperativa") return goLogin();

      myUid = user.uid;
      myUser = profile;
      myTerritoryId = profile.territoryId || null;

      const name = profile.displayName || profile.name || user.email || "Usu√°rio";
      hdrSubtitle.textContent = `Cooperativa ‚Ä¢ ${name}`;
      badgeUser.textContent = `üë§ ${name}`;
      badgeTerritory.textContent = `Territ√≥rio: ${myTerritoryId || "‚Äî"}`;

      chipStatus.textContent = status;

      pName.textContent = profile.displayName || profile.name || "‚Äî";
      pEmail.textContent = profile.email || user.email || "‚Äî";
      pRole.textContent = role || "‚Äî";
      pTerr.textContent = myTerritoryId || "‚Äî";
      pUid.textContent = user.uid;

      buildMaterialsUI();
      clearForm();
      stopAll();
      await loadTerritory();
      startLogs();
      startNotices();
      startContents();

      document.documentElement.style.visibility = "visible";
      setSection("dashboard");
      notify("Bem-vindo(a)! ‚úÖ");
    });
  </script>

  <!--
    =============================
    REGRAS FIRESTORE (necess√°rio)
    =============================
    Para o input funcionar, crie rules para daily_logs:

    match /daily_logs/{logId} {
      allow create: if isCoop()
        && request.resource.data.territoryId == myTerritoryId()
        && request.resource.data.createdBy == me();

      allow get, list: if isCoop()
        && resource.data.territoryId == myTerritoryId();

      allow update: if isCoop()
        && resource.data.territoryId == myTerritoryId()
        && resource.data.createdBy == me();

      allow delete: if isCoop()
        && resource.data.territoryId == myTerritoryId()
        && resource.data.createdBy == me();

      allow read, write: if isGov();
    }
  -->
</body>
</html>
