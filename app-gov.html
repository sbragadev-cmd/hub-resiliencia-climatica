<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hub Resili√™ncia Clim√°tica ‚Ä¢ Governan√ßa</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Poppins:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --green:#1B7F5A;
      --green2:#4CAF8F;
      --blue:#0D3B66;
      --yellow:#F2C94C;
      --bg:#F5F7F6;
      --card:#ffffff;
      --graphite:#182018;
      --muted:#5B6B62;
      --line: rgba(13,59,102,.12);
      --shadow: 0 18px 50px rgba(13,59,102,.10);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--graphite);
      background:
        radial-gradient(900px 700px at 90% 0%, rgba(13,59,102,.06), transparent 55%),
        linear-gradient(180deg, #eef4f1 0%, #f6faf8 60%, #ffffff 100%);
      overflow-x:hidden;
    }
    html{ visibility:hidden; }

    /* TOPBAR */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,.86);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(13,59,102,.08);
    }
    .topbar-inner{
      max-width: 1280px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 240px;
    }
    .logo{
      width: 40px; height: 40px;
      border-radius: 14px;
      display:grid; place-items:center;
      background: rgba(13,59,102,.08);
      border: 1px solid rgba(13,59,102,.14);
      box-shadow: 0 12px 24px rgba(13,59,102,.10);
      font-size: 18px;
    }
    .brand strong{
      font-family: Poppins, Inter, sans-serif;
      letter-spacing: -.02em;
      font-size: 14px;
      display:block;
      line-height: 1.1;
    }
    .brand span{
      display:block;
      font-size: 12px;
      font-weight: 900;
      opacity: .75;
      margin-top: 2px;
    }

    .actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .pill{
      border: 1px solid rgba(13,59,102,.14);
      background: rgba(245,247,246,.92);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 900;
      cursor:pointer;
      display:flex; align-items:center; gap:10px;
      color: rgba(13,59,102,.92);
      white-space: nowrap;
    }
    .badge{
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 1000;
      background: rgba(13,59,102,.06);
      border: 1px solid rgba(13,59,102,.12);
      color: rgba(13,59,102,.92);
      font-size: 12px;
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }
    .badge.good{
      background: rgba(27,127,90,.10);
      border: 1px solid rgba(27,127,90,.18);
      color: rgba(12,77,68,.95);
    }
    .badge.warn{
      background: rgba(242,201,76,.16);
      border: 1px solid rgba(242,201,76,.30);
      color: rgba(91,74,18,.95);
    }

    /* LAYOUT */
    .layout{
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px 18px 38px;
      display:grid;
      grid-template-columns: 300px 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
    }
    .sidebar{
      position: sticky;
      top: 78px;
      align-self: start;
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(13,59,102,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      backdrop-filter: blur(10px);
    }
    @media (max-width: 980px){
      .sidebar{ position: relative; top: 0; }
    }
    .nav-title{
      font-family: Poppins, Inter, sans-serif;
      font-weight: 800;
      letter-spacing: -.02em;
      font-size: 14px;
      margin: 4px 0 10px;
      color: rgba(13,59,102,.95);
    }
    .nav{
      display:flex;
      flex-direction: column;
      gap: 8px;
    }
    .nav button{
      width: 100%;
      text-align:left;
      border: 1px solid rgba(13,59,102,.12);
      background: rgba(245,247,246,.70);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 1000;
      cursor:pointer;
      color: rgba(13,59,102,.92);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      transition: transform .12s ease, filter .18s ease, background .18s ease;
    }
    .nav button:hover{ filter: brightness(1.01); transform: translateY(-1px); }
    .nav button.active{
      background: rgba(13,59,102,.10);
      border-color: rgba(13,59,102,.18);
      color: rgba(13,59,102,.95);
    }
    .nav small{ font-weight: 1000; opacity: .75; }

    .content{ min-height: 60vh; }
    .section{ display:none; }
    .section.active{ display:block; }

    .card{
      background: var(--card);
      border: 1px solid rgba(13,59,102,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 14px;
    }
    .card h2{
      margin: 2px 0 8px;
      font-family: Poppins, Inter, sans-serif;
      font-size: 16px;
      letter-spacing: -.02em;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .sub{
      color: rgba(24,32,24,.68);
      font-weight: 800;
      font-size: 12.5px;
      line-height: 1.5;
      margin: 0 0 12px;
      max-width: 110ch;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 860px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .kpi{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 900px){
      .kpi{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 560px){
      .kpi{ grid-template-columns: 1fr; }
    }
    .kpi .box{
      border: 1px solid rgba(13,59,102,.10);
      background: rgba(245,247,246,.70);
      border-radius: 16px;
      padding: 12px;
    }
    .kpi .box b{
      display:block;
      font-size: 18px;
      font-weight: 1000;
      letter-spacing: -.02em;
    }
    .kpi .box span{
      display:block;
      margin-top: 4px;
      font-size: 12px;
      font-weight: 900;
      opacity: .7;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(13,59,102,.14);
      background: rgba(255,255,255,.86);
      font-weight: 1000;
      font-size: 12px;
      color: rgba(13,59,102,.92);
      white-space: nowrap;
    }
    .chip.good{
      border-color: rgba(27,127,90,.22);
      background: rgba(27,127,90,.12);
      color: rgba(12,77,68,.95);
    }
    .chip.warn{
      border-color: rgba(242,201,76,.40);
      background: rgba(242,201,76,.16);
      color: rgba(91,74,18,.95);
    }

    .table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 16px;
      border: 1px solid rgba(13,59,102,.10);
    }
    .table th, .table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(13,59,102,.08);
      font-size: 12.5px;
      text-align:left;
      vertical-align: top;
    }
    .table th{
      background: rgba(13,59,102,.05);
      color: rgba(13,59,102,.90);
      font-weight: 1000;
    }
    .table td{
      background: rgba(245,247,246,.60);
      color: rgba(24,32,24,.82);
      font-weight: 900;
    }
    .table tr:last-child td{ border-bottom:none; }

    .searchbar{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      margin: 10px 0 12px;
    }
    .input{
      flex: 1 1 260px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(13,59,102,.14);
      background: rgba(242,246,255,.55);
      outline: none;
      font-weight: 900;
    }
    .input:focus{
      border-color: rgba(13,59,102,.28);
      box-shadow: 0 0 0 4px rgba(13,59,102,.10);
      background: rgba(242,246,255,.80);
    }
    .select{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(13,59,102,.14);
      background: rgba(255,255,255,.92);
      font-weight: 900;
      cursor:pointer;
      width: 100%;
    }
    textarea.input{ min-height: 90px; resize: vertical; line-height: 1.35; }

    .btn{
      border: 1px solid rgba(13,59,102,.18);
      background: rgba(255,255,255,.92);
      color: rgba(13,59,102,.92);
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 1000;
      cursor: pointer;
      font-size: 12.5px;
      white-space: nowrap;
    }
    .btn.primary{
      border: 1px solid rgba(27,127,90,.22);
      background: rgba(27,127,90,.12);
      color: rgba(12,77,68,.95);
    }
    .btn.danger{
      border: 1px solid rgba(220,38,38,.22);
      background: rgba(220,38,38,.08);
      color: rgba(153,27,27,.95);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .row-actions{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
      margin-top: 10px;
    }

    .muted-note{
      margin-top: 10px;
      font-size: 12px;
      font-weight: 900;
      color: rgba(24,32,24,.60);
      line-height: 1.45;
      white-space: pre-line;
    }

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      max-width: 560px;
      z-index: 99;
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(13,59,102,.12);
      box-shadow: 0 18px 50px rgba(13,59,102,.14);
      border-radius: 16px;
      padding: 10px 12px;
      display:none;
      font-weight: 900;
      color: rgba(24,32,24,.80);
      white-space: pre-line;
    }
    .toast.show{ display:block; }

    .mini{
      font-size: 12px;
      font-weight: 900;
      color: rgba(24,32,24,.62);
    }

    code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">üèõÔ∏è</div>
        <div>
          <strong>Hub Resili√™ncia Clim√°tica</strong>
          <span id="hdrSubtitle">Governan√ßa ‚Ä¢ Carregando...</span>
        </div>
      </div>

      <div class="actions">
        <span class="badge good" id="badgeRole">role: ‚Äî</span>
        <span class="badge" id="badgeUser">‚Äî</span>
        <button class="pill" id="btnRefresh" type="button">üîÑ <span>Atualizar</span></button>
        <button class="pill" id="btnLogout" type="button">üö™ <span>Sair</span></button>
      </div>
    </div>
  </header>

  <main class="layout">
    <aside class="sidebar">
      <div class="nav-title">Menu governan√ßa</div>
      <nav class="nav">
        <button data-section="home" class="active"><span>üìå Vis√£o geral</span><small>KPIs</small></button>
        <button data-section="users"><span>üë• Usu√°rios</span><small>ativos + pendentes</small></button>
        <button data-section="territories"><span>üó∫Ô∏è Territ√≥rios</span><small>CRUD</small></button>
        <button data-section="contents"><span>üìö Conte√∫dos</span><small>materiais</small></button>
        <button data-section="notices"><span>üì£ Avisos</span><small>comunicados</small></button>
        <button data-section="plans"><span>üß≠ Planos</span><small>a√ß√£o</small></button>
        <button data-section="profile"><span>üë§ Meu perfil</span><small>dados</small></button>
      </nav>

      <p class="muted-note">
        Acesso permitido apenas para <b>admin/governanca/gestor</b> com <b>status=active</b>.
        As abas s√≥ aparecem quando voc√™ clica no menu.
      </p>
    </aside>

    <section class="content">
      <!-- HOME -->
      <div id="section-home" class="section active">
        <div class="card">
          <h2>
            <span>Vis√£o geral</span>
            <span class="chip good" id="chipReady">üü¢ online</span>
          </h2>
          <p class="sub">
            Vis√£o r√°pida da plataforma: usu√°rios, solicita√ß√µes, territ√≥rios e conte√∫dos.
          </p>

          <div class="kpi">
            <div class="box">
              <b id="kpiUsersActive">0</b>
              <span>Usu√°rios ativos</span>
            </div>
            <div class="box">
              <b id="kpiUsersPending">0</b>
              <span>Usu√°rios pendentes</span>
            </div>
            <div class="box">
              <b id="kpiReqPending">0</b>
              <span>Solicita√ß√µes pendentes</span>
            </div>
            <div class="box">
              <b id="kpiTerritories">0</b>
              <span>Territ√≥rios</span>
            </div>
          </div>

          <div class="muted-note" id="homeHint">
            Dica: use <b>Usu√°rios</b> para aprovar e atribuir territ√≥rios (territoryId).
          </div>
        </div>

        <div class="card">
          <h2>
            <span>Atalhos</span>
            <span class="chip">‚ö° r√°pido</span>
          </h2>
          <div class="row-actions" style="justify-content:flex-start;">
            <button class="btn" id="goUsers" type="button">üë• Ir para Usu√°rios</button>
            <button class="btn" id="goTerr" type="button">üó∫Ô∏è Ir para Territ√≥rios</button>
            <button class="btn" id="goContent" type="button">üìö Ir para Conte√∫dos</button>
            <button class="btn" id="goNotices" type="button">üì£ Ir para Avisos</button>
          </div>
        </div>
      </div>

      <!-- USERS -->
      <div id="section-users" class="section">
        <div class="card">
          <h2>
            <span>Solicita√ß√µes de aprova√ß√£o</span>
            <span class="chip warn" id="chipReq">‚è≥ 0</span>
          </h2>
          <p class="sub">
            Lista de <code>access_requests</code> pendentes (aprovar/rejeitar).
            Ao aprovar, o sistema atualiza <code>users/{uid}</code> (status/role/territoryId).
          </p>

          <div class="searchbar">
            <input id="reqSearch" class="input" placeholder="Buscar (nome, email, uid, territ√≥rio)...">
          </div>

          <table class="table">
            <thead>
              <tr>
                <th>Usu√°rio</th>
                <th>Pedido</th>
                <th>Territ√≥rio</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tbodyReq">
              <tr><td colspan="4" class="mini">Carregando‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>

        <div class="card">
          <h2>
            <span>Usu√°rios ativos</span>
            <span class="chip good" id="chipActive">‚úÖ 0</span>
          </h2>

          <div class="searchbar">
            <input id="uSearchActive" class="input" placeholder="Buscar ativo (nome, email, uid, territ√≥rio)...">
          </div>

          <table class="table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>E-mail</th>
                <th>Role</th>
                <th>Territ√≥rio</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="tbodyActive">
              <tr><td colspan="5" class="mini">Carregando‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>

        <div class="card">
          <h2>
            <span>Usu√°rios pendentes</span>
            <span class="chip warn" id="chipPending">üïí 0</span>
          </h2>

          <div class="searchbar">
            <input id="uSearchPending" class="input" placeholder="Buscar pendente (nome, email, uid)...">
          </div>

          <table class="table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>E-mail</th>
                <th>Role</th>
                <th>Territ√≥rio</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tbodyPending">
              <tr><td colspan="5" class="mini">Carregando‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>

        <!-- NEW: UPDATE TERRITORY -->
        <div class="card">
          <h2>
            <span>Atualizar territ√≥rio do usu√°rio</span>
            <span class="chip">üó∫Ô∏è governan√ßa</span>
          </h2>
          <p class="sub">
            Selecione um usu√°rio e atribua o <b>territoryId</b>. Isso controla o acesso do app-coop e o filtro de dados.
          </p>

          <div class="grid2">
            <div>
              <label class="mini"><b>Usu√°rio</b></label>
              <select id="selUserTerr" class="select">
                <option value="">Carregando usu√°rios‚Ä¶</option>
              </select>
              <div class="muted-note" id="userTerrMeta">‚Äî</div>
            </div>

            <div>
              <label class="mini"><b>Territ√≥rio</b></label>
              <select id="selTerritory" class="select">
                <option value="">Carregando territ√≥rios‚Ä¶</option>
              </select>
              <div class="muted-note">Dica: o valor salvo no usu√°rio ser√° o <b>ID do doc</b> em <code>territories/{territoryId}</code>. Voc√™ pode deixar vazio para remover.</div>
            </div>
          </div>

          <div class="row-actions" style="margin-top:10px;">
            <button class="btn" id="btnClearTerr" type="button">üßπ Limpar</button>
            <button class="btn primary" id="btnSaveTerr" type="button">üíæ Salvar territ√≥rio</button>
          </div>

          <div class="muted-note" id="terrSaveMsg">‚Äî</div>
        </div>
      </div>

      <!-- TERRITORIES -->
      <div id="section-territories" class="section">
        <div class="card">
          <h2>
            <span>Territ√≥rios ‚Ä¢ Cadastro</span>
            <span class="chip">üó∫Ô∏è CRUD</span>
          </h2>
          <p class="sub">
            Crie/edite territ√≥rios em <code>territories</code>. O <b>ID do documento</b> √© o <code>territoryId</code>.
          </p>

          <div class="grid2">
            <div>
              <label class="mini"><b>ID (opcional)</b></label>
              <input id="tId" class="input" placeholder="Ex: crc_centro (se vazio, auto-id)">
              <div class="muted-note">Se voc√™ preencher, o doc ser√° criado com esse ID. Se vazio, o Firestore gera.</div>
            </div>
            <div>
              <label class="mini"><b>Nome</b></label>
              <input id="tName" class="input" placeholder="Ex: CRGR Centro">
            </div>
          </div>

          <div class="grid2">
            <div>
              <label class="mini"><b>Cidade</b></label>
              <input id="tCity" class="input" placeholder="Cidade">
            </div>
            <div>
              <label class="mini"><b>UF</b></label>
              <input id="tState" class="input" placeholder="UF">
            </div>
          </div>

          <div class="grid2">
            <div>
              <label class="mini"><b>CRC/CRGR (nome)</b></label>
              <input id="tCrcName" class="input" placeholder="Nome do CRC/CRGR">
            </div>
            <div>
              <label class="mini"><b>C√≥digo</b></label>
              <input id="tCode" class="input" placeholder="C√≥digo interno">
            </div>
          </div>

          <div>
            <label class="mini"><b>Descri√ß√£o</b></label>
            <textarea id="tDesc" class="input" placeholder="Descri√ß√£o do territ√≥rio, hor√°rios, opera√ß√£o..."></textarea>
          </div>

          <div class="grid2">
            <div>
              <label class="mini"><b>Contatos (texto)</b></label>
              <textarea id="tContacts" class="input" placeholder="Ex: Coordena√ß√£o: (xx) xxxx-xxxx&#10;E-mail: ..."></textarea>
            </div>
            <div>
              <label class="mini"><b>Links (um por linha)</b></label>
              <textarea id="tLinks" class="input" placeholder="https://...&#10;https://..."></textarea>
            </div>
          </div>

          <div class="row-actions">
            <button class="btn" id="btnTerrClear" type="button">üßπ Limpar</button>
            <button class="btn primary" id="btnTerrSave" type="button">üíæ Salvar (criar/atualizar)</button>
          </div>

          <div class="muted-note" id="terrMsg">‚Äî</div>
        </div>

        <div class="card">
          <h2>
            <span>Lista de territ√≥rios</span>
            <span class="chip" id="chipTerr">üó∫Ô∏è 0</span>
          </h2>

          <div class="searchbar">
            <input id="tSearch" class="input" placeholder="Buscar territ√≥rio (nome, id, cidade, uf)...">
          </div>

          <table class="table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>ID</th>
                <th>Cidade/UF</th>
                <th>CRC</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tbodyTerr">
              <tr><td colspan="5" class="mini">Carregando‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- CONTENTS -->
      <div id="section-contents" class="section">
        <div class="card">
          <h2>
            <span>Conte√∫dos ‚Ä¢ Criar/editar</span>
            <span class="chip">üìö materials</span>
          </h2>
          <p class="sub">
            Conte√∫dos em <code>contents</code>. Cooperativas veem os do seu territ√≥rio e os gerais (<code>territoryId=null</code>), quando <code>status="published"</code>.
          </p>

          <div class="grid2">
            <div>
              <label class="mini"><b>ID (para editar)</b></label>
              <input id="cId" class="input" placeholder="Cole o ID para carregar/editar (opcional)">
            </div>
            <div>
              <label class="mini"><b>T√≠tulo</b></label>
              <input id="cTitle" class="input" placeholder="T√≠tulo do conte√∫do">
            </div>
          </div>

          <div class="grid2">
            <div>
              <label class="mini"><b>N√≠vel</b></label>
              <select id="cLevel" class="select">
                <option value="iniciante">iniciante</option>
                <option value="operacional">operacional</option>
                <option value="gestao">gestao</option>
              </select>
            </div>
            <div>
              <label class="mini"><b>Territ√≥rio</b></label>
              <select id="cTerritory" class="select">
                <option value="">Geral (null)</option>
              </select>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label class="mini"><b>Tipo</b></label>
              <select id="cType" class="select">
                <option value="material">material</option>
                <option value="video">video</option>
                <option value="link">link</option>
                <option value="documento">documento</option>
              </select>
            </div>
            <div>
              <label class="mini"><b>Status</b></label>
              <select id="cStatus" class="select">
                <option value="published">published</option>
                <option value="draft">draft</option>
              </select>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label class="mini"><b>URL (opcional)</b></label>
              <input id="cUrl" class="input" placeholder="https://...">
            </div>
            <div>
              <label class="mini"><b>Resumo</b></label>
              <input id="cSummary" class="input" placeholder="Resumo curto">
            </div>
          </div>

          <div>
            <label class="mini"><b>Texto (body)</b></label>
            <textarea id="cBody" class="input" placeholder="Conte√∫do completo..."></textarea>
          </div>

          <div class="row-actions">
            <button class="btn" id="btnContentClear" type="button">üßπ Limpar</button>
            <button class="btn primary" id="btnContentSave" type="button">üíæ Salvar</button>
            <button class="btn danger" id="btnContentDelete" type="button">üóëÔ∏è Excluir</button>
          </div>

          <div class="muted-note" id="contentMsg">‚Äî</div>
        </div>

        <div class="card">
          <h2>
            <span>Lista de conte√∫dos</span>
            <span class="chip" id="chipContent">üìö 0</span>
          </h2>

          <div class="searchbar">
            <input id="cSearch" class="input" placeholder="Buscar (t√≠tulo, resumo, n√≠vel, tipo)...">
            <select id="cFilterStatus" class="select" style="max-width:260px;">
              <option value="">Todos status</option>
              <option value="published">published</option>
              <option value="draft">draft</option>
            </select>
          </div>

          <table class="table">
            <thead>
              <tr>
                <th>T√≠tulo</th>
                <th>Territ√≥rio</th>
                <th>N√≠vel</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tbodyContent">
              <tr><td colspan="5" class="mini">Carregando‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- NOTICES -->
      <div id="section-notices" class="section">
        <div class="card">
          <h2>
            <span>Avisos ‚Ä¢ Criar/editar</span>
            <span class="chip">üì£ notices</span>
          </h2>
          <p class="sub">
            Avisos em <code>notices</code>. Cooperativas veem os do territ√≥rio e os gerais (<code>territoryId=null</code>), quando <code>active=true</code>.
          </p>

          <div class="grid2">
            <div>
              <label class="mini"><b>ID (para editar)</b></label>
              <input id="nId" class="input" placeholder="Cole o ID para carregar/editar (opcional)">
            </div>
            <div>
              <label class="mini"><b>T√≠tulo</b></label>
              <input id="nTitle" class="input" placeholder="T√≠tulo do aviso">
            </div>
          </div>

          <div class="grid2">
            <div>
              <label class="mini"><b>Territ√≥rio</b></label>
              <select id="nTerritory" class="select">
                <option value="">Geral (null)</option>
              </select>
            </div>
            <div>
              <label class="mini"><b>Prioridade</b></label>
              <select id="nPriority" class="select">
                <option value="normal">normal</option>
                <option value="alta">alta</option>
              </select>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label class="mini"><b>Ativo?</b></label>
              <select id="nActive" class="select">
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
            </div>
            <div>
              <label class="mini"><b>Tags (opcional)</b></label>
              <input id="nTags" class="input" placeholder="Ex: seguran√ßa, opera√ß√£o, evento">
            </div>
          </div>

          <div>
            <label class="mini"><b>Mensagem</b></label>
            <textarea id="nBody" class="input" placeholder="Texto do aviso..."></textarea>
          </div>

          <div class="row-actions">
            <button class="btn" id="btnNoticeClear" type="button">üßπ Limpar</button>
            <button class="btn primary" id="btnNoticeSave" type="button">üíæ Salvar</button>
            <button class="btn danger" id="btnNoticeDelete" type="button">üóëÔ∏è Excluir</button>
          </div>

          <div class="muted-note" id="noticeMsg">‚Äî</div>
        </div>

        <div class="card">
          <h2>
            <span>Lista de avisos</span>
            <span class="chip" id="chipNotice">üì£ 0</span>
          </h2>

          <div class="searchbar">
            <input id="nSearchList" class="input" placeholder="Buscar (t√≠tulo, texto, territ√≥rio, prioridade)...">
            <select id="nFilterActive" class="select" style="max-width:260px;">
              <option value="">Todos</option>
              <option value="true">ativos</option>
              <option value="false">inativos</option>
            </select>
          </div>

          <table class="table">
            <thead>
              <tr>
                <th>T√≠tulo</th>
                <th>Territ√≥rio</th>
                <th>Prioridade</th>
                <th>Ativo</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tbodyNotice">
              <tr><td colspan="5" class="mini">Carregando‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- PLANS -->
      <div id="section-plans" class="section">
        <div class="card">
          <h2>
            <span>Planos de a√ß√£o</span>
            <span class="chip">üß≠ action_plans</span>
          </h2>
          <p class="sub">
            (Base) lista de <code>action_plans</code>. Voc√™ pode evoluir isso depois com metas, respons√°veis e prazos.
          </p>

          <div class="searchbar">
            <input id="pSearch" class="input" placeholder="Buscar plano...">
          </div>

          <table class="table">
            <thead>
              <tr>
                <th>T√≠tulo</th>
                <th>Territ√≥rio</th>
                <th>Status</th>
                <th>Prazo</th>
              </tr>
            </thead>
            <tbody id="tbodyPlans">
              <tr><td colspan="4" class="mini">Carregando‚Ä¶</td></tr>
            </tbody>
          </table>

          <p class="muted-note">
            Se voc√™ quiser, eu completo esta aba com CRUD, checklists e indicadores.
          </p>
        </div>
      </div>

      <!-- PROFILE -->
      <div id="section-profile" class="section">
        <div class="card">
          <h2>
            <span>Meu perfil</span>
            <span class="chip good" id="chipStatus">‚Äî</span>
          </h2>

          <table class="table">
            <tbody>
              <tr><th style="width:180px;">Nome</th><td id="pName">‚Äî</td></tr>
              <tr><th>E-mail</th><td id="pEmail">‚Äî</td></tr>
              <tr><th>Role</th><td id="pRole">‚Äî</td></tr>
              <tr><th>Status</th><td id="pStatus">‚Äî</td></tr>
              <tr><th>UID</th><td id="pUid">‚Äî</td></tr>
            </tbody>
          </table>

          <p class="muted-note">
            Voc√™ pode aprovar usu√°rios e atribuir territ√≥rio em <b>Usu√°rios</b>.
          </p>
        </div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { auth, db } from "./assets/firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      collection,
      query,
      where,
      limit,
      onSnapshot,
      getDocs,
      getDoc,
      doc,
      setDoc,
      addDoc,
      updateDoc,
      deleteDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ========= UI: menu/sections =========
    const navButtons = Array.from(document.querySelectorAll(".nav button[data-section]"));
    const sections = Array.from(document.querySelectorAll(".section"));
    function setSection(key){
      navButtons.forEach(b => b.classList.toggle("active", b.dataset.section === key));
      sections.forEach(s => s.classList.toggle("active", s.id === `section-${key}`));
    }
    navButtons.forEach(b => b.addEventListener("click", () => setSection(b.dataset.section)));

    // Home shortcuts
    document.getElementById("goUsers").addEventListener("click", ()=> setSection("users"));
    document.getElementById("goTerr").addEventListener("click", ()=> setSection("territories"));
    document.getElementById("goContent").addEventListener("click", ()=> setSection("contents"));
    document.getElementById("goNotices").addEventListener("click", ()=> setSection("notices"));

    // ========= Toast =========
    const toast = document.getElementById("toast");
    function notify(text){
      toast.textContent = text;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2800);
    }

    // ========= Helpers =========
    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }
    function norm(v){ return String(v ?? "").trim(); }
    function lower(v){ return norm(v).toLowerCase(); }
    function tsToMillis(t){
      if (!t) return 0;
      if (typeof t.toMillis === "function") return t.toMillis();
      if (typeof t.seconds === "number") return (t.seconds * 1000) + Math.floor((t.nanoseconds||0)/1e6);
      const d = new Date(t);
      const ms = d.getTime();
      return Number.isFinite(ms) ? ms : 0;
    }
    function mergeById(list){
      const map = new Map();
      for (const x of list) map.set(x.id, x);
      return Array.from(map.values());
    }
    function renderEmpty(tbody, colSpan, text){
      tbody.innerHTML = `<tr><td colspan="${colSpan}" class="mini">${esc(text)}</td></tr>`;
    }

    // ========= Header =========
    const hdrSubtitle = document.getElementById("hdrSubtitle");
    const badgeRole = document.getElementById("badgeRole");
    const badgeUser = document.getElementById("badgeUser");
    const btnLogout = document.getElementById("btnLogout");
    const btnRefresh = document.getElementById("btnRefresh");
    function goLogin(){ window.location.href = "login.html"; }
    btnLogout.addEventListener("click", async () => { try{ await signOut(auth);} finally{ goLogin(); } });

    // ========= Profile =========
    const chipStatus = document.getElementById("chipStatus");
    const pName = document.getElementById("pName");
    const pEmail = document.getElementById("pEmail");
    const pRole = document.getElementById("pRole");
    const pStatus = document.getElementById("pStatus");
    const pUid = document.getElementById("pUid");

    // ========= KPIs =========
    const kpiUsersActive = document.getElementById("kpiUsersActive");
    const kpiUsersPending = document.getElementById("kpiUsersPending");
    const kpiReqPending = document.getElementById("kpiReqPending");
    const kpiTerritories = document.getElementById("kpiTerritories");

    // ========= USERS UI =========
    const chipReq = document.getElementById("chipReq");
    const tbodyReq = document.getElementById("tbodyReq");
    const reqSearch = document.getElementById("reqSearch");

    const chipActive = document.getElementById("chipActive");
    const tbodyActive = document.getElementById("tbodyActive");
    const uSearchActive = document.getElementById("uSearchActive");

    const chipPending = document.getElementById("chipPending");
    const tbodyPending = document.getElementById("tbodyPending");
    const uSearchPending = document.getElementById("uSearchPending");

    // Territory assignment UI (NEW)
    const selUserTerr = document.getElementById("selUserTerr");
    const selTerritory = document.getElementById("selTerritory");
    const btnSaveTerr = document.getElementById("btnSaveTerr");
    const btnClearTerr = document.getElementById("btnClearTerr");
    const userTerrMeta = document.getElementById("userTerrMeta");
    const terrSaveMsg = document.getElementById("terrSaveMsg");

    function setTerrMsg(text, ok=true){
      terrSaveMsg.textContent = text;
      terrSaveMsg.style.color = ok ? "rgba(12,77,68,.95)" : "rgba(91,74,18,.95)";
    }

    // ========= TERRITORIES UI =========
    const chipTerr = document.getElementById("chipTerr");
    const tbodyTerr = document.getElementById("tbodyTerr");
    const tSearch = document.getElementById("tSearch");

    const tId = document.getElementById("tId");
    const tName = document.getElementById("tName");
    const tCity = document.getElementById("tCity");
    const tState = document.getElementById("tState");
    const tCrcName = document.getElementById("tCrcName");
    const tCode = document.getElementById("tCode");
    const tDesc = document.getElementById("tDesc");
    const tContacts = document.getElementById("tContacts");
    const tLinks = document.getElementById("tLinks");
    const btnTerrClear = document.getElementById("btnTerrClear");
    const btnTerrSave = document.getElementById("btnTerrSave");
    const terrMsg = document.getElementById("terrMsg");

    function setTerrCrudMsg(text, ok=true){
      terrMsg.textContent = text;
      terrMsg.style.color = ok ? "rgba(12,77,68,.95)" : "rgba(91,74,18,.95)";
    }

    // ========= CONTENTS UI =========
    const chipContent = document.getElementById("chipContent");
    const tbodyContent = document.getElementById("tbodyContent");
    const cSearch = document.getElementById("cSearch");
    const cFilterStatus = document.getElementById("cFilterStatus");

    const cId = document.getElementById("cId");
    const cTitle = document.getElementById("cTitle");
    const cLevel = document.getElementById("cLevel");
    const cTerritory = document.getElementById("cTerritory");
    const cType = document.getElementById("cType");
    const cStatus = document.getElementById("cStatus");
    const cUrl = document.getElementById("cUrl");
    const cSummary = document.getElementById("cSummary");
    const cBody = document.getElementById("cBody");
    const btnContentClear = document.getElementById("btnContentClear");
    const btnContentSave = document.getElementById("btnContentSave");
    const btnContentDelete = document.getElementById("btnContentDelete");
    const contentMsg = document.getElementById("contentMsg");

    function setContentMsg(text, ok=true){
      contentMsg.textContent = text;
      contentMsg.style.color = ok ? "rgba(12,77,68,.95)" : "rgba(91,74,18,.95)";
    }

    // ========= NOTICES UI =========
    const chipNotice = document.getElementById("chipNotice");
    const tbodyNotice = document.getElementById("tbodyNotice");
    const nSearchList = document.getElementById("nSearchList");
    const nFilterActive = document.getElementById("nFilterActive");

    const nId = document.getElementById("nId");
    const nTitle = document.getElementById("nTitle");
    const nTerritory = document.getElementById("nTerritory");
    const nPriority = document.getElementById("nPriority");
    const nActive = document.getElementById("nActive");
    const nTags = document.getElementById("nTags");
    const nBody = document.getElementById("nBody");
    const btnNoticeClear = document.getElementById("btnNoticeClear");
    const btnNoticeSave = document.getElementById("btnNoticeSave");
    const btnNoticeDelete = document.getElementById("btnNoticeDelete");
    const noticeMsg = document.getElementById("noticeMsg");

    function setNoticeMsg(text, ok=true){
      noticeMsg.textContent = text;
      noticeMsg.style.color = ok ? "rgba(12,77,68,.95)" : "rgba(91,74,18,.95)";
    }

    // ========= PLANS UI =========
    const tbodyPlans = document.getElementById("tbodyPlans");
    const pSearch = document.getElementById("pSearch");

    // ========= State =========
    let myUid = null;
    let myUser = null;

    let unsubUsers = null;
    let unsubReq = null;
    let unsubTerr = null;
    let unsubContents = null;
    let unsubNotices = null;
    let unsubPlans = null;

    let USERS_CACHE = [];      // {uid,data}
    let REQ_CACHE = [];        // {id,data}
    let TERR_CACHE = [];       // {id,data}
    let CONTENTS_CACHE = [];   // {id,data}
    let NOTICES_CACHE = [];    // {id,data}
    let PLANS_CACHE = [];      // {id,data}

    function stopAll(){
      if (typeof unsubUsers === "function") unsubUsers();
      if (typeof unsubReq === "function") unsubReq();
      if (typeof unsubTerr === "function") unsubTerr();
      if (typeof unsubContents === "function") unsubContents();
      if (typeof unsubNotices === "function") unsubNotices();
      if (typeof unsubPlans === "function") unsubPlans();
      unsubUsers = unsubReq = unsubTerr = unsubContents = unsubNotices = unsubPlans = null;
    }

    // ========= Start listeners =========
    function startUsers(){
      unsubUsers = onSnapshot(query(collection(db, "users"), limit(800)), (snap) => {
        USERS_CACHE = [];
        snap.forEach(d => USERS_CACHE.push({ uid: d.id, data: d.data() || {} }));
        renderUsers();
        renderUserTerritoryPicker();
        renderKpis();
      }, (err)=> {
        console.error(err);
        renderEmpty(tbodyActive, 5, `Erro: ${err.code || err.message}`);
        renderEmpty(tbodyPending, 5, `Erro: ${err.code || err.message}`);
      });
    }

    function startRequests(){
      unsubReq = onSnapshot(query(collection(db, "access_requests"), limit(800)), (snap) => {
        REQ_CACHE = [];
        snap.forEach(d => REQ_CACHE.push({ id: d.id, data: d.data() || {} }));
        renderRequests();
        renderKpis();
      }, (err)=>{
        console.error(err);
        renderEmpty(tbodyReq, 4, `Erro: ${err.code || err.message}`);
      });
    }

    function startTerritories(){
      unsubTerr = onSnapshot(query(collection(db, "territories"), limit(800)), (snap) => {
        TERR_CACHE = [];
        snap.forEach(d => TERR_CACHE.push({ id: d.id, data: d.data() || {} }));
        renderTerritories();
        renderTerritorySelects();
        renderKpis();
      }, (err)=>{
        console.error(err);
        renderEmpty(tbodyTerr, 5, `Erro: ${err.code || err.message}`);
      });
    }

    function startContents(){
      unsubContents = onSnapshot(query(collection(db, "contents"), limit(800)), (snap) => {
        CONTENTS_CACHE = [];
        snap.forEach(d => CONTENTS_CACHE.push({ id: d.id, data: d.data() || {} }));
        renderContents();
        renderKpis();
      }, (err)=>{
        console.error(err);
        renderEmpty(tbodyContent, 5, `Erro: ${err.code || err.message}`);
      });
    }

    function startNotices(){
      unsubNotices = onSnapshot(query(collection(db, "notices"), limit(800)), (snap) => {
        NOTICES_CACHE = [];
        snap.forEach(d => NOTICES_CACHE.push({ id: d.id, data: d.data() || {} }));
        renderNotices();
        renderKpis();
      }, (err)=>{
        console.error(err);
        renderEmpty(tbodyNotice, 5, `Erro: ${err.code || err.message}`);
      });
    }

    function startPlans(){
      unsubPlans = onSnapshot(query(collection(db, "action_plans"), limit(800)), (snap) => {
        PLANS_CACHE = [];
        snap.forEach(d => PLANS_CACHE.push({ id: d.id, data: d.data() || {} }));
        renderPlans();
      }, (err)=>{
        console.error(err);
        renderEmpty(tbodyPlans, 4, `Erro: ${err.code || err.message}`);
      });
    }

    // ========= KPIs =========
    function renderKpis(){
      const users = USERS_CACHE.map(x => x.data || {});
      const active = users.filter(u => lower(u.status) === "active").length;
      const pending = users.filter(u => lower(u.status) === "pending").length;

      const reqPending = REQ_CACHE.filter(r => lower(r.data.status || "pending") === "pending").length;
      const terrCount = TERR_CACHE.length;

      kpiUsersActive.textContent = String(active);
      kpiUsersPending.textContent = String(pending);
      kpiReqPending.textContent = String(reqPending);
      kpiTerritories.textContent = String(terrCount);

      chipReq.textContent = `‚è≥ ${reqPending}`;
      chipActive.textContent = `‚úÖ ${active}`;
      chipPending.textContent = `üïí ${pending}`;
      chipTerr.textContent = `üó∫Ô∏è ${terrCount}`;
      chipContent.textContent = `üìö ${CONTENTS_CACHE.length}`;
      chipNotice.textContent = `üì£ ${NOTICES_CACHE.length}`;
    }

    // ========= USERS rendering =========
    function renderUsers(){
      const sA = lower(uSearchActive.value);
      const sP = lower(uSearchPending.value);

      const usersNorm = USERS_CACHE.map(x => {
        const u = x.data || {};
        return {
          uid: x.uid,
          name: u.displayName || u.name || "(sem nome)",
          email: u.email || "",
          role: lower(u.role),
          status: lower(u.status),
          territoryId: u.territoryId || "",
        };
      });

      const act = usersNorm
        .filter(u => u.status === "active")
        .filter(u => !sA || (lower(u.name).includes(sA) || lower(u.email).includes(sA) || lower(u.uid).includes(sA) || lower(u.territoryId).includes(sA)))
        .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

      const pend = usersNorm
        .filter(u => u.status !== "active") // pending/other
        .filter(u => !sP || (lower(u.name).includes(sP) || lower(u.email).includes(sP) || lower(u.uid).includes(sP)))
        .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

      if (act.length === 0) renderEmpty(tbodyActive, 5, "Nenhum usu√°rio ativo (ou filtrado).");
      else {
        tbodyActive.innerHTML = act.map(u => `
          <tr>
            <td>${esc(u.name)}</td>
            <td>${esc(u.email)}</td>
            <td><span class="chip">${esc(u.role || "‚Äî")}</span></td>
            <td><span class="chip">${esc(u.territoryId || "‚Äî")}</span></td>
            <td><span class="chip good">active</span></td>
          </tr>
        `).join("");
      }

      if (pend.length === 0) renderEmpty(tbodyPending, 5, "Nenhum usu√°rio pendente (ou filtrado).");
      else {
        tbodyPending.innerHTML = pend.map(u => `
          <tr>
            <td>${esc(u.name)}</td>
            <td>${esc(u.email)}</td>
            <td><span class="chip">${esc(u.role || "‚Äî")}</span></td>
            <td><span class="chip">${esc(u.territoryId || "‚Äî")}</span></td>
            <td>
              <button class="btn primary" data-act="activate" data-uid="${esc(u.uid)}">‚úÖ Ativar</button>
              <button class="btn" data-act="setpending" data-uid="${esc(u.uid)}">üïí Pending</button>
              <button class="btn danger" data-act="delete" data-uid="${esc(u.uid)}">üóëÔ∏è Excluir</button>
            </td>
          </tr>
        `).join("");
      }
    }

    tbodyPending.addEventListener("click", async (ev) => {
      const btn = ev.target.closest("button[data-act]");
      if (!btn) return;
      const act = btn.dataset.act;
      const uid = btn.dataset.uid;
      if (!uid) return;

      try{
        if (act === "activate"){
          await updateDoc(doc(db, "users", uid), { status: "active", updatedAt: serverTimestamp() });
          notify("Usu√°rio ativado ‚úÖ");
        } else if (act === "setpending"){
          await updateDoc(doc(db, "users", uid), { status: "pending", updatedAt: serverTimestamp() });
          notify("Usu√°rio marcado como pending ‚úÖ");
        } else if (act === "delete"){
          if (!confirm("Excluir usu√°rio (doc users/{uid})?")) return;
          await deleteDoc(doc(db, "users", uid));
          notify("Usu√°rio exclu√≠do ‚úÖ");
        }
      }catch(err){
        console.error(err);
        notify(`Erro: ${err.code || err.message}`);
      }
    });

    uSearchActive.addEventListener("input", renderUsers);
    uSearchPending.addEventListener("input", renderUsers);

    // ========= REQUESTS rendering + approve/reject =========
    function renderRequests(){
      const s = lower(reqSearch.value);

      const list = REQ_CACHE
        .map(x => ({ id: x.id, data: x.data || {} }))
        .filter(x => lower(x.data.status || "pending") === "pending")
        .filter(x => {
          if (!s) return true;
          const d = x.data || {};
          return (
            lower(d.uid).includes(s) ||
            lower(d.email).includes(s) ||
            lower(d.name).includes(s) ||
            lower(d.role).includes(s) ||
            lower(d.territoryId).includes(s)
          );
        })
        .sort((a,b)=> tsToMillis(b.data.createdAt) - tsToMillis(a.data.createdAt));

      if (list.length === 0) renderEmpty(tbodyReq, 4, "Nenhuma solicita√ß√£o pendente (ou filtrada).");
      else {
        tbodyReq.innerHTML = list.map(x => {
          const d = x.data || {};
          const who = `${d.name || "(sem nome)"} ‚Ä¢ ${d.email || ""} ‚Ä¢ uid: ${d.uid || "‚Äî"}`;
          const role = d.role || "cooperativa";
          const territoryId = d.territoryId || "";
          return `
            <tr>
              <td>${esc(who)}</td>
              <td>
                <span class="chip">${esc(role)}</span>
                <span class="chip warn">pending</span>
              </td>
              <td><span class="chip">${esc(territoryId || "‚Äî")}</span></td>
              <td>
                <button class="btn primary" data-act="approve" data-id="${esc(x.id)}">‚úÖ Aprovar</button>
                <button class="btn danger" data-act="reject" data-id="${esc(x.id)}">‚õî Rejeitar</button>
              </td>
            </tr>
          `;
        }).join("");
      }
    }

    reqSearch.addEventListener("input", renderRequests);

    tbodyReq.addEventListener("click", async (ev) => {
      const btn = ev.target.closest("button[data-act]");
      if (!btn) return;
      const act = btn.dataset.act;
      const reqId = btn.dataset.id;
      const req = REQ_CACHE.find(x => x.id === reqId);
      if (!req) return;

      const d = req.data || {};
      const uid = d.uid;
      const role = lower(d.role) || "cooperativa";
      const territoryId = d.territoryId || null;

      try{
        if (act === "approve"){
          if (!uid) throw new Error("Solicita√ß√£o sem uid.");

          // atualiza usu√°rio
          await updateDoc(doc(db, "users", uid), {
            status: "active",
            role: role,
            territoryId: territoryId,
            updatedAt: serverTimestamp()
          });

          // marca request
          await updateDoc(doc(db, "access_requests", reqId), {
            status: "approved",
            decidedBy: myUid,
            decidedAt: serverTimestamp()
          });

          notify("Solicita√ß√£o aprovada ‚úÖ");
        }

        if (act === "reject"){
          if (!confirm("Rejeitar solicita√ß√£o?")) return;
          await updateDoc(doc(db, "access_requests", reqId), {
            status: "rejected",
            decidedBy: myUid,
            decidedAt: serverTimestamp()
          });
          notify("Solicita√ß√£o rejeitada ‚úÖ");
        }
      }catch(err){
        console.error(err);
        notify(`Erro: ${err.code || err.message}`);
      }
    });

    // ========= NEW: Update territory picker =========
    function renderUserTerritoryPicker(){
      if (!selUserTerr) return;

      const users = USERS_CACHE.map(x => {
        const u = x.data || {};
        return {
          uid: x.uid,
          name: u.displayName || u.name || "(sem nome)",
          email: u.email || "",
          role: lower(u.role),
          status: lower(u.status),
          territoryId: u.territoryId || ""
        };
      }).sort((a,b)=> (a.name||"").localeCompare(b.name||""));

      const current = selUserTerr.value || "";
      selUserTerr.innerHTML =
        `<option value="">Selecione um usu√°rio‚Ä¶</option>` +
        users.map(u => {
          const label = `${u.name} ‚Ä¢ ${u.role||"-"} ‚Ä¢ ${u.status||"-"} ‚Ä¢ ${u.email||""}`.trim();
          return `<option value="${esc(u.uid)}">${esc(label)}</option>`;
        }).join("");

      if (current && users.some(u => u.uid === current)){
        selUserTerr.value = current;
      } else {
        selUserTerr.value = "";
        userTerrMeta.textContent = "‚Äî";
      }
    }

    function renderTerritorySelects(){
      const terrs = TERR_CACHE.map(x => ({ id: x.id, name: x.data?.name || x.data?.nome || x.id }))
        .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

      // users picker territory select
      if (selTerritory){
        const cur = selTerritory.value || "";
        selTerritory.innerHTML = `<option value="">(vazio) remover</option>` + terrs.map(t => `
          <option value="${esc(t.id)}">${esc(t.name)} ‚Ä¢ (${esc(t.id)})</option>
        `).join("");
        if (cur && terrs.some(t => t.id === cur)) selTerritory.value = cur;
      }

      // content territory select
      if (cTerritory){
        const curC = cTerritory.value || "";
        cTerritory.innerHTML = `<option value="">Geral (null)</option>` + terrs.map(t => `
          <option value="${esc(t.id)}">${esc(t.name)} ‚Ä¢ (${esc(t.id)})</option>
        `).join("");
        if (curC && terrs.some(t => t.id === curC)) cTerritory.value = curC;
      }

      // notice territory select
      if (nTerritory){
        const curN = nTerritory.value || "";
        nTerritory.innerHTML = `<option value="">Geral (null)</option>` + terrs.map(t => `
          <option value="${esc(t.id)}">${esc(t.name)} ‚Ä¢ (${esc(t.id)})</option>
        `).join("");
        if (curN && terrs.some(t => t.id === curN)) nTerritory.value = curN;
      }
    }

    selUserTerr?.addEventListener("change", () => {
      const uid = selUserTerr.value || "";
      const u = USERS_CACHE.find(x => x.uid === uid)?.data || null;
      if (!u){
        userTerrMeta.textContent = "‚Äî";
        selTerritory.value = "";
        setTerrMsg("‚Äî", true);
        return;
      }
      userTerrMeta.textContent = `Atual: territoryId = ${u.territoryId || "(vazio)"} ‚Ä¢ UID: ${uid}`;
      selTerritory.value = u.territoryId || "";
      setTerrMsg("‚Äî", true);
    });

    btnClearTerr?.addEventListener("click", () => {
      selUserTerr.value = "";
      selTerritory.value = "";
      userTerrMeta.textContent = "‚Äî";
      setTerrMsg("‚Äî", true);
    });

    btnSaveTerr?.addEventListener("click", async () => {
      const uid = selUserTerr.value || "";
      const territoryId = selTerritory.value || "";

      if (!uid){
        setTerrMsg("Selecione um usu√°rio.", false);
        return;
      }

      btnSaveTerr.disabled = true;
      btnSaveTerr.textContent = "Salvando...";

      try{
        await updateDoc(doc(db, "users", uid), {
          territoryId: territoryId || null,
          updatedAt: serverTimestamp()
        });
        setTerrMsg("Territ√≥rio atualizado com sucesso ‚úÖ", true);
        notify("Territ√≥rio atualizado ‚úÖ");
      }catch(err){
        console.error(err);
        setTerrMsg(`Erro ao salvar: ${err.code || err.message}`, false);
        notify(`Erro: ${err.code || err.message}`);
      }finally{
        btnSaveTerr.disabled = false;
        btnSaveTerr.textContent = "üíæ Salvar territ√≥rio";
      }
    });

    // ========= TERRITORIES CRUD =========
    function terrClear(){
      tId.value = "";
      tName.value = "";
      tCity.value = "";
      tState.value = "";
      tCrcName.value = "";
      tCode.value = "";
      tDesc.value = "";
      tContacts.value = "";
      tLinks.value = "";
      setTerrCrudMsg("‚Äî", true);
    }
    btnTerrClear.addEventListener("click", terrClear);

    btnTerrSave.addEventListener("click", async () => {
      const id = norm(tId.value);
      const data = {
        name: norm(tName.value) || null,
        city: norm(tCity.value) || null,
        state: norm(tState.value) || null,
        crcName: norm(tCrcName.value) || null,
        code: norm(tCode.value) || null,
        description: norm(tDesc.value) || null,
        contactsText: norm(tContacts.value) || null,
        links: norm(tLinks.value)
          ? norm(tLinks.value).split("\n").map(s => norm(s)).filter(Boolean)
          : [],
        updatedAt: serverTimestamp()
      };

      if (!data.name){
        setTerrCrudMsg("Informe o nome do territ√≥rio.", false);
        return;
      }

      btnTerrSave.disabled = true;
      btnTerrSave.textContent = "Salvando...";

      try{
        if (id){
          // upsert fixed id
          await setDoc(doc(db, "territories", id), {
            ...data,
            createdAt: serverTimestamp()
          }, { merge: true });
          setTerrCrudMsg(`Territ√≥rio salvo ‚úÖ (ID: ${id})`, true);
        } else {
          // auto-id
          await addDoc(collection(db, "territories"), {
            ...data,
            createdAt: serverTimestamp()
          });
          setTerrCrudMsg("Territ√≥rio criado ‚úÖ (auto-id)", true);
        }
        notify("Territ√≥rio salvo ‚úÖ");
        terrClear();
      }catch(err){
        console.error(err);
        setTerrCrudMsg(`Erro: ${err.code || err.message}`, false);
        notify(`Erro: ${err.code || err.message}`);
      }finally{
        btnTerrSave.disabled = false;
        btnTerrSave.textContent = "üíæ Salvar (criar/atualizar)";
      }
    });

    function renderTerritories(){
      const s = lower(tSearch.value);
      const list = TERR_CACHE
        .map(x => ({
          id: x.id,
          name: x.data?.name || x.data?.nome || x.id,
          city: x.data?.city || "",
          state: x.data?.state || "",
          crcName: x.data?.crcName || "",
          data: x.data || {}
        }))
        .filter(t => !s || (lower(t.name).includes(s) || lower(t.id).includes(s) || lower(t.city).includes(s) || lower(t.state).includes(s) || lower(t.crcName).includes(s)))
        .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

      chipTerr.textContent = `üó∫Ô∏è ${list.length}`;

      if (list.length === 0) renderEmpty(tbodyTerr, 5, "Nenhum territ√≥rio (ou filtrado).");
      else {
        tbodyTerr.innerHTML = list.map(t => `
          <tr>
            <td>${esc(t.name)}</td>
            <td><span class="chip">${esc(t.id)}</span></td>
            <td>${esc([t.city, t.state].filter(Boolean).join(" / ") || "‚Äî")}</td>
            <td>${esc(t.crcName || "‚Äî")}</td>
            <td>
              <button class="btn" data-act="edit" data-id="${esc(t.id)}">‚úèÔ∏è Editar</button>
              <button class="btn danger" data-act="del" data-id="${esc(t.id)}">üóëÔ∏è Excluir</button>
            </td>
          </tr>
        `).join("");
      }
    }
    tSearch.addEventListener("input", renderTerritories);

    tbodyTerr.addEventListener("click", async (ev) => {
      const btn = ev.target.closest("button[data-act]");
      if (!btn) return;
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if (!id) return;

      if (act === "edit"){
        const t = TERR_CACHE.find(x => x.id === id);
        if (!t) return;
        const d = t.data || {};
        tId.value = id;
        tName.value = d.name || "";
        tCity.value = d.city || "";
        tState.value = d.state || "";
        tCrcName.value = d.crcName || "";
        tCode.value = d.code || "";
        tDesc.value = d.description || d.desc || "";
        tContacts.value = d.contactsText || "";
        tLinks.value = Array.isArray(d.links) ? d.links.join("\n") : "";
        setTerrCrudMsg(`Editando: ${id}`, true);
        notify("Territ√≥rio carregado para edi√ß√£o ‚úèÔ∏è");
        setSection("territories");
      }

      if (act === "del"){
        if (!confirm(`Excluir territ√≥rio ${id}?`)) return;
        try{
          await deleteDoc(doc(db, "territories", id));
          notify("Territ√≥rio exclu√≠do ‚úÖ");
        }catch(err){
          console.error(err);
          notify(`Erro: ${err.code || err.message}`);
        }
      }
    });

    // ========= CONTENTS CRUD =========
    function contentClear(){
      cId.value = "";
      cTitle.value = "";
      cLevel.value = "iniciante";
      cTerritory.value = "";
      cType.value = "material";
      cStatus.value = "published";
      cUrl.value = "";
      cSummary.value = "";
      cBody.value = "";
      setContentMsg("‚Äî", true);
    }
    btnContentClear.addEventListener("click", contentClear);

    async function loadContentById(id){
      const snap = await getDoc(doc(db, "contents", id));
      if (!snap.exists()){
        setContentMsg("Conte√∫do n√£o encontrado.", false);
        return;
      }
      const d = snap.data() || {};
      cId.value = id;
      cTitle.value = d.title || "";
      cLevel.value = d.level || d.nivel || "iniciante";
      cTerritory.value = d.territoryId || "";
      cType.value = d.type || "material";
      cStatus.value = d.status || "published";
      cUrl.value = d.url || "";
      cSummary.value = d.summary || "";
      cBody.value = d.body || "";
      setContentMsg(`Editando: ${id}`, true);
      notify("Conte√∫do carregado ‚úèÔ∏è");
    }

    btnContentSave.addEventListener("click", async () => {
      const id = norm(cId.value);
      const data = {
        title: norm(cTitle.value) || null,
        level: norm(cLevel.value) || "iniciante",
        territoryId: norm(cTerritory.value) || null,
        type: norm(cType.value) || "material",
        status: norm(cStatus.value) || "published",
        url: norm(cUrl.value) || null,
        summary: norm(cSummary.value) || null,
        body: norm(cBody.value) || null,
        updatedAt: serverTimestamp()
      };

      if (!data.title){
        setContentMsg("Informe o t√≠tulo.", false);
        return;
      }

      btnContentSave.disabled = true;
      btnContentSave.textContent = "Salvando...";

      try{
        if (id){
          await setDoc(doc(db, "contents", id), { ...data, createdAt: serverTimestamp() }, { merge:true });
          setContentMsg(`Conte√∫do salvo ‚úÖ (ID: ${id})`, true);
        } else {
          await addDoc(collection(db, "contents"), { ...data, createdAt: serverTimestamp() });
          setContentMsg("Conte√∫do criado ‚úÖ (auto-id)", true);
        }
        notify("Conte√∫do salvo ‚úÖ");
        contentClear();
      }catch(err){
        console.error(err);
        setContentMsg(`Erro: ${err.code || err.message}`, false);
        notify(`Erro: ${err.code || err.message}`);
      }finally{
        btnContentSave.disabled = false;
        btnContentSave.textContent = "üíæ Salvar";
      }
    });

    btnContentDelete.addEventListener("click", async () => {
      const id = norm(cId.value);
      if (!id){
        setContentMsg("Informe um ID para excluir.", false);
        return;
      }
      if (!confirm(`Excluir conte√∫do ${id}?`)) return;

      try{
        await deleteDoc(doc(db, "contents", id));
        notify("Conte√∫do exclu√≠do ‚úÖ");
        contentClear();
      }catch(err){
        console.error(err);
        notify(`Erro: ${err.code || err.message}`);
      }
    });

    function renderContents(){
      const s = lower(cSearch.value);
      const fs = lower(cFilterStatus.value);

      const list = CONTENTS_CACHE
        .map(x => ({
          id: x.id,
          d: x.data || {}
        }))
        .filter(x => {
          const d = x.d;
          if (fs && lower(d.status) !== fs) return false;
          if (!s) return true;
          return (
            lower(d.title).includes(s) ||
            lower(d.summary).includes(s) ||
            lower(d.level || d.nivel).includes(s) ||
            lower(d.type).includes(s)
          );
        })
        .sort((a,b)=> tsToMillis(b.d.updatedAt || b.d.createdAt) - tsToMillis(a.d.updatedAt || a.d.createdAt));

      chipContent.textContent = `üìö ${list.length}`;

      if (list.length === 0) renderEmpty(tbodyContent, 5, "Nenhum conte√∫do (ou filtrado).");
      else {
        tbodyContent.innerHTML = list.map(x => {
          const d = x.d;
          const terr = d.territoryId ? d.territoryId : "geral";
          const st = lower(d.status || "published");
          const stChip = st === "published" ? `<span class="chip good">published</span>` : `<span class="chip warn">draft</span>`;
          return `
            <tr>
              <td>${esc(d.title || "‚Äî")}</td>
              <td><span class="chip">${esc(terr)}</span></td>
              <td><span class="chip">${esc(d.level || d.nivel || "‚Äî")}</span></td>
              <td>${stChip}</td>
              <td>
                <button class="btn" data-act="edit" data-id="${esc(x.id)}">‚úèÔ∏è Editar</button>
                <button class="btn danger" data-act="del" data-id="${esc(x.id)}">üóëÔ∏è Excluir</button>
              </td>
            </tr>
          `;
        }).join("");
      }
    }

    cSearch.addEventListener("input", renderContents);
    cFilterStatus.addEventListener("change", renderContents);

    tbodyContent.addEventListener("click", async (ev) => {
      const btn = ev.target.closest("button[data-act]");
      if (!btn) return;
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if (!id) return;

      if (act === "edit"){
        await loadContentById(id);
        setSection("contents");
      }
      if (act === "del"){
        if (!confirm(`Excluir conte√∫do ${id}?`)) return;
        try{
          await deleteDoc(doc(db, "contents", id));
          notify("Conte√∫do exclu√≠do ‚úÖ");
        }catch(err){
          console.error(err);
          notify(`Erro: ${err.code || err.message}`);
        }
      }
    });

    cId.addEventListener("change", async () => {
      const id = norm(cId.value);
      if (id) await loadContentById(id);
    });

    // ========= NOTICES CRUD =========
    function noticeClear(){
      nId.value = "";
      nTitle.value = "";
      nTerritory.value = "";
      nPriority.value = "normal";
      nActive.value = "true";
      nTags.value = "";
      nBody.value = "";
      setNoticeMsg("‚Äî", true);
    }
    btnNoticeClear.addEventListener("click", noticeClear);

    async function loadNoticeById(id){
      const snap = await getDoc(doc(db, "notices", id));
      if (!snap.exists()){
        setNoticeMsg("Aviso n√£o encontrado.", false);
        return;
      }
      const d = snap.data() || {};
      nId.value = id;
      nTitle.value = d.title || "";
      nTerritory.value = d.territoryId || "";
      nPriority.value = d.priority || "normal";
      nActive.value = String(d.active !== false);
      nTags.value = Array.isArray(d.tags) ? d.tags.join(", ") : (d.tags || "");
      nBody.value = d.body || "";
      setNoticeMsg(`Editando: ${id}`, true);
      notify("Aviso carregado ‚úèÔ∏è");
    }

    btnNoticeSave.addEventListener("click", async () => {
      const id = norm(nId.value);
      const data = {
        title: norm(nTitle.value) || null,
        territoryId: norm(nTerritory.value) || null,
        priority: norm(nPriority.value) || "normal",
        active: (String(nActive.value) === "true"),
        tags: norm(nTags.value) ? norm(nTags.value).split(",").map(s => norm(s)).filter(Boolean) : [],
        body: norm(nBody.value) || null,
        updatedAt: serverTimestamp()
      };

      if (!data.title || !data.body){
        setNoticeMsg("Informe t√≠tulo e mensagem.", false);
        return;
      }

      btnNoticeSave.disabled = true;
      btnNoticeSave.textContent = "Salvando...";

      try{
        if (id){
          await setDoc(doc(db, "notices", id), { ...data, createdAt: serverTimestamp() }, { merge:true });
          setNoticeMsg(`Aviso salvo ‚úÖ (ID: ${id})`, true);
        } else {
          await addDoc(collection(db, "notices"), { ...data, createdAt: serverTimestamp() });
          setNoticeMsg("Aviso criado ‚úÖ (auto-id)", true);
        }
        notify("Aviso salvo ‚úÖ");
        noticeClear();
      }catch(err){
        console.error(err);
        setNoticeMsg(`Erro: ${err.code || err.message}`, false);
        notify(`Erro: ${err.code || err.message}`);
      }finally{
        btnNoticeSave.disabled = false;
        btnNoticeSave.textContent = "üíæ Salvar";
      }
    });

    btnNoticeDelete.addEventListener("click", async () => {
      const id = norm(nId.value);
      if (!id){
        setNoticeMsg("Informe um ID para excluir.", false);
        return;
      }
      if (!confirm(`Excluir aviso ${id}?`)) return;

      try{
        await deleteDoc(doc(db, "notices", id));
        notify("Aviso exclu√≠do ‚úÖ");
        noticeClear();
      }catch(err){
        console.error(err);
        notify(`Erro: ${err.code || err.message}`);
      }
    });

    function renderNotices(){
      const s = lower(nSearchList.value);
      const fa = lower(nFilterActive.value);

      const list = NOTICES_CACHE
        .map(x => ({ id: x.id, d: x.data || {} }))
        .filter(x => {
          if (fa){
            const isActive = (x.d.active !== false);
            if (fa === "true" && !isActive) return false;
            if (fa === "false" && isActive) return false;
          }
          if (!s) return true;
          return (
            lower(x.d.title).includes(s) ||
            lower(x.d.body).includes(s) ||
            lower(x.d.priority).includes(s) ||
            lower(x.d.territoryId).includes(s)
          );
        })
        .sort((a,b)=> tsToMillis(b.d.updatedAt || b.d.createdAt) - tsToMillis(a.d.updatedAt || a.d.createdAt));

      chipNotice.textContent = `üì£ ${list.length}`;

      if (list.length === 0) renderEmpty(tbodyNotice, 5, "Nenhum aviso (ou filtrado).");
      else {
        tbodyNotice.innerHTML = list.map(x => {
          const d = x.d;
          const terr = d.territoryId ? d.territoryId : "geral";
          const pr = lower(d.priority || "normal");
          const prChip = pr === "alta" ? `<span class="chip warn">‚ö†Ô∏è alta</span>` : `<span class="chip">üìå normal</span>`;
          const active = (d.active !== false);
          const aChip = active ? `<span class="chip good">true</span>` : `<span class="chip warn">false</span>`;

          return `
            <tr>
              <td>${esc(d.title || "‚Äî")}</td>
              <td><span class="chip">${esc(terr)}</span></td>
              <td>${prChip}</td>
              <td>${aChip}</td>
              <td>
                <button class="btn" data-act="edit" data-id="${esc(x.id)}">‚úèÔ∏è Editar</button>
                <button class="btn danger" data-act="del" data-id="${esc(x.id)}">üóëÔ∏è Excluir</button>
              </td>
            </tr>
          `;
        }).join("");
      }
    }

    nSearchList.addEventListener("input", renderNotices);
    nFilterActive.addEventListener("change", renderNotices);

    tbodyNotice.addEventListener("click", async (ev) => {
      const btn = ev.target.closest("button[data-act]");
      if (!btn) return;
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if (!id) return;

      if (act === "edit"){
        await loadNoticeById(id);
        setSection("notices");
      }
      if (act === "del"){
        if (!confirm(`Excluir aviso ${id}?`)) return;
        try{
          await deleteDoc(doc(db, "notices", id));
          notify("Aviso exclu√≠do ‚úÖ");
        }catch(err){
          console.error(err);
          notify(`Erro: ${err.code || err.message}`);
        }
      }
    });

    nId.addEventListener("change", async () => {
      const id = norm(nId.value);
      if (id) await loadNoticeById(id);
    });

    // ========= PLANS render (base) =========
    function renderPlans(){
      const s = lower(pSearch.value);
      const list = PLANS_CACHE
        .map(x => ({ id: x.id, d: x.data || {} }))
        .filter(x => {
          if (!s) return true;
          return lower(x.d.title).includes(s) || lower(x.d.status).includes(s) || lower(x.d.territoryId).includes(s);
        })
        .sort((a,b)=> tsToMillis(b.d.updatedAt || b.d.createdAt) - tsToMillis(a.d.updatedAt || a.d.createdAt));

      if (list.length === 0) renderEmpty(tbodyPlans, 4, "Nenhum plano (ou filtrado).");
      else {
        tbodyPlans.innerHTML = list.map(x => {
          const d = x.d;
          const terr = d.territoryId || "‚Äî";
          const st = d.status || "‚Äî";
          const due = d.dueDate || d.deadline || "‚Äî";
          return `
            <tr>
              <td>${esc(d.title || "‚Äî")}</td>
              <td><span class="chip">${esc(terr)}</span></td>
              <td><span class="chip">${esc(st)}</span></td>
              <td>${esc(due)}</td>
            </tr>
          `;
        }).join("");
      }
    }
    pSearch.addEventListener("input", renderPlans);

    // ========= Manual refresh =========
    btnRefresh.addEventListener("click", async () => {
      notify("Atualizando‚Ä¶");
      renderKpis();
      renderUsers();
      renderRequests();
      renderTerritories();
      renderContents();
      renderNotices();
      renderPlans();
      notify("Atualizado ‚úÖ");
    });

    // ========= Guard: gov only =========
    onAuthStateChanged(auth, async (user) => {
      if (!user) return goLogin();

      const snap = await getDoc(doc(db, "users", user.uid));
      if (!snap.exists()) return goLogin();

      const profile = snap.data() || {};
      const status = lower(profile.status);
      const role = lower(profile.role);

      const isGov = (status === "active") && (["admin","governanca","gestor"].includes(role));
      if (!isGov) return goLogin();

      myUid = user.uid;
      myUser = profile;

      const name = profile.displayName || profile.name || user.email || "Usu√°rio";
      hdrSubtitle.textContent = `Governan√ßa ‚Ä¢ ${name}`;
      badgeUser.textContent = `üë§ ${name}`;
      badgeRole.textContent = `role: ${role || "‚Äî"}`;
      chipStatus.textContent = status;

      pName.textContent = profile.displayName || profile.name || "‚Äî";
      pEmail.textContent = profile.email || user.email || "‚Äî";
      pRole.textContent = role || "‚Äî";
      pStatus.textContent = status || "‚Äî";
      pUid.textContent = user.uid;

      stopAll();
      startUsers();
      startRequests();
      startTerritories();
      startContents();
      startNotices();
      startPlans();

      // defaults
      setSection("home");
      setTerrMsg("‚Äî", true);
      setTerrCrudMsg("‚Äî", true);
      setContentMsg("‚Äî", true);
      setNoticeMsg("‚Äî", true);

      document.documentElement.style.visibility = "visible";
      notify("Bem-vindo(a), governan√ßa ‚úÖ");
    });
  </script>


</body>
</html>
